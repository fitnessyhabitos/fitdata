<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fit Data">
    <meta name="theme-color" content="#050505">

    <title>Fit Data | High Performance</title>
    
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-color: #050505;
            --card-color: #121212;
            --input-bg: #1f1f1f;
            --text-color: #ffffff;
            --text-dim: #888888;
            --accent-color: #ff3333; /* Rojo Ne√≥n */
            --accent-glow: 0 0 15px rgba(255, 51, 51, 0.5);
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: 60px;
            --nav-height: 80px; /* M√°s altura para evitar toques fantasma en iOS */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            height: 100dvh; /* Dynamic Viewport Height para Safari */
            width: 100vw;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
        }

        /* --- UTILIDADES --- */
        .hidden { display: none !important; }
        .btn {
            background: var(--accent-color); color: white; border: none; padding: 14px;
            border-radius: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; width: 100%; box-shadow: var(--accent-glow);
            display: flex; justify-content: center; align-items: center; gap: 8px; font-size: 0.9rem;
        }
        .btn:active { transform: scale(0.98); }
        .btn-outline { 
            background: transparent; border: 1px solid #444; color: #ccc; 
            padding: 12px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer;
            margin-top: 10px; font-size: 0.85rem;
        }

        /* --- LOADING SCREEN --- */
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-color); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #loading-logo { 
            width: 120px; 
            filter: drop-shadow(0 0 20px var(--accent-color));
            animation: breathe 3s infinite ease-in-out;
        }
        .loading-text {
            margin-top: 20px; color: var(--accent-color); font-family: monospace;
            font-size: 1rem; letter-spacing: 3px; font-weight: bold;
            text-shadow: 0 0 10px var(--accent-color);
            animation: blink 0.8s infinite;
        }
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.8; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* --- HEADER --- */
        header {
            flex-shrink: 0; 
            height: calc(var(--header-height) + var(--safe-top));
            padding-top: var(--safe-top); 
            background: rgba(5, 5, 5, 0.98);
            border-bottom: 1px solid #222; 
            display: flex; justify-content: space-between; align-items: center;
            padding-left: 20px; padding-right: 20px; 
            z-index: 100;
        }
        .brand { font-weight: 900; font-size: 1.2rem; color: white; letter-spacing: -0.5px; }
        .brand span { color: var(--accent-color); }
        
        .btn-neon-text {
            background: transparent; border: 1px solid var(--accent-color);
            color: var(--accent-color); font-weight: 800; text-shadow: 0 0 5px var(--accent-color);
            padding: 5px 12px; border-radius: 4px; font-size: 0.7rem; letter-spacing: 1px;
            box-shadow: inset 0 0 10px rgba(255, 51, 51, 0.1);
        }

        /* --- SCROLL CONTAINER --- */
        #main-container { 
            flex: 1; 
            overflow-y: auto; 
            position: relative; 
            scroll-behavior: smooth; 
            -webkit-overflow-scrolling: touch; 
        }
        .view-container {
            min-height: 100%; 
            padding: 20px 15px 180px 15px; /* PADDING EXTRA GRANDE PARA IPHONE */
            display: none; opacity: 0; animation: fadeIn 0.3s forwards;
        }
        .view-container.active { display: block; opacity: 1; }
        @keyframes fadeIn { to { opacity: 1; } }

        /* --- UI ELEMENTS --- */
        .card { background: var(--card-color); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #222; position: relative; }
        input, select { background: var(--input-bg); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 10px; font-size: 16px; }
        input:focus { outline: 1px solid var(--accent-color); }

        /* --- PERFIL --- */
        .profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .avatar-circle {
            width: 70px; height: 70px; border-radius: 50%; background: #222;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--accent-color); overflow: hidden; position: relative;
        }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        
        .muscle-bar-group { margin-bottom: 8px; }
        .muscle-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: #ccc; margin-bottom: 2px; }
        .progress-track { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ff3333, #ff6666); width: 0%; transition: width 1s ease; }

        /* --- IMAGENES DE EJERCICIOS CON FALLBACK --- */
        .ex-select-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px; background: #1a1a1a; margin-bottom: 5px; border-radius: 6px;
            cursor: pointer; border: 1px solid transparent;
        }
        .ex-select-item img { width: 40px; height: 40px; object-fit: contain; background: black; border-radius: 4px; border: 1px solid #333; }
        .ex-select-item.selected { border-color: var(--accent-color); background: rgba(255,51,51,0.1); }

        /* --- NAV BOTTOM (AJUSTADO IOS) --- */
        nav.bottom-nav {
            flex-shrink: 0; 
            height: calc(var(--nav-height) + var(--safe-bottom));
            padding-bottom: var(--safe-bottom); 
            background: #0f0f0f; 
            border-top: 1px solid #222;
            display: flex; justify-content: space-around; 
            z-index: 999;
        }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; font-size: 0.65rem; }
        .nav-item.active { color: var(--accent-color); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }

        /* --- WORKOUT --- */
        .exercise-visual {
            width: 100%; height: 160px; background: #000; border-radius: 8px; margin-bottom: 10px;
            overflow: hidden; border: 1px solid #333; position: relative; display: flex; justify-content: center;
        }
        .exercise-visual img { height: 100%; object-fit: contain; }
        .set-row {
            display: grid; grid-template-columns: 25px 1fr 1fr 45px; gap: 8px;
            align-items: center; margin-bottom: 8px; font-size: 0.9rem;
        }

        /* --- MODAL --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9);
            z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none;
        }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1a1a1a; width: 90%; max-width: 350px; padding: 20px; border-radius: 12px; border: 1px solid var(--accent-color); text-align: center; }

        .btn-float {
            position: absolute; bottom: 30px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%; background: var(--accent-color);
            color: white; display: grid; place-items: center; font-size: 24px; box-shadow: 0 5px 15px rgba(255,51,51,0.5);
            z-index: 80;
        }
        
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(18px); }

        /* Slider Fotos */
        .compare-wrapper { position: relative; width: 100%; height: 250px; background: #000; border-radius: 8px; overflow: hidden; margin-top:10px; }
        .compare-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        .img-overlay { clip-path: inset(0 50% 0 0); transition: clip-path 0s; }
        .slider-handle { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; background: white; cursor: ew-resize; z-index: 10; }
        .slider-btn { position: absolute; top: 50%; left: -14px; width: 28px; height: 28px; background: white; border-radius: 50%; display: grid; place-items: center; color: black; font-size:12px; box-shadow: 0 0 5px black; }

    </style>
</head>
<body>

    <div id="loading-screen">
        <img src="logo.png" id="loading-logo" alt="Logo" onerror="this.style.display='none'">
        <div class="loading-text">SYSTEM INITIALIZED</div>
    </div>

    <header id="main-header" class="hidden">
        <div class="brand">FIT DATA <span>PRO</span></div>
        <button id="coach-btn" class="hidden btn-neon-text">COACH</button>
    </header>

    <main id="main-container">

        <section id="auth-view" class="view-container">
            <div style="text-align:center; margin-top:40px; margin-bottom:40px;">
                <img src="logo.png" style="width:100px; margin-bottom:20px;" onerror="this.src='https://placehold.co/100x100?text=LOGO'">
                <h1>ACCESO SEGURO</h1>
            </div>
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-pass" placeholder="Contrase√±a">
                <button class="btn" id="btn-login">ENTRAR</button>
                <button class="btn-outline" onclick="toggleAuth('register')">CREAR CUENTA</button>
            </div>
            <div id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="Nombre">
                <input type="email" id="reg-email" placeholder="Email">
                <input type="password" id="reg-pass" placeholder="Contrase√±a">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="reg-age" placeholder="Edad">
                    <input type="number" id="reg-height" placeholder="Altura (cm)">
                </div>
                <input type="text" id="reg-code" placeholder="C√ìDIGO SECRETO">
                <button class="btn" id="btn-register">SOLICITAR ACCESO</button>
                <button class="btn-outline" onclick="toggleAuth('login')">VOLVER</button>
            </div>
        </section>

        <section id="routines-view" class="view-container">
            <h2>MIS RUTINAS</h2>
            <div id="routines-list"></div>
            <button class="btn-float" onclick="openRoutineEditor()">+</button>
        </section>

        <section id="editor-view" class="view-container">
            <h2>EDITOR DE RUTINA</h2>
            <input type="text" id="editor-name" placeholder="Nombre de la Rutina">
            <div class="card" style="max-height: 500px; display:flex; flex-direction:column;">
                <div style="position:sticky; top:0; background:var(--card-color); padding-bottom:10px; z-index:10;">
                    <h3>Selecci√≥n de Ejercicios</h3>
                    <input type="search" id="ex-search" placeholder="üîç Buscar ejercicio..." oninput="filterExercises(this.value)">
                </div>
                <div id="exercise-selector-list" style="overflow-y:auto; flex:1;"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="saveRoutine()">GUARDAR</button>
                <button class="btn-outline" style="margin:0" onclick="switchTab('routines-view')">CANCELAR</button>
            </div>
        </section>

        <section id="profile-view" class="view-container">
            <div class="profile-header">
                <div class="avatar-circle" onclick="document.getElementById('file-avatar').click()">
                    <img id="avatar-img" src="" style="display:none;">
                    <span id="avatar-text" style="font-size:1.5rem; color:var(--accent-color);">U</span>
                </div>
                <input type="file" id="file-avatar" accept="image/*" class="hidden" onchange="uploadAvatar(this)">
                <div>
                    <h3 id="profile-name" style="margin:0;">Cargando...</h3>
                    <span style="color:#666; font-size:0.8rem;">Atleta</span>
                </div>
            </div>
            <div class="card">
                <h3>MAPA MUSCULAR</h3>
                <div id="heatmap-container"></div>
            </div>
            <div class="card">
                <h3>COMPARATIVA FOTOS</h3>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <button class="btn-outline" onclick="document.getElementById('f-before').click()">1. ANTES</button>
                    <button class="btn-outline" onclick="document.getElementById('f-after').click()">2. AHORA</button>
                </div>
                <input type="file" id="f-before" class="hidden" accept="image/*" onchange="loadCompImg(this,'img-before')">
                <input type="file" id="f-after" class="hidden" accept="image/*" onchange="loadCompImg(this,'img-overlay')">
                <div class="compare-wrapper" id="compare-box">
                    <img src="" id="img-before" class="compare-img" alt="A">
                    <img src="" id="img-overlay" class="compare-img img-overlay" alt="B">
                    <div class="slider-handle" id="slider-handle"><div class="slider-btn">‚Üî</div></div>
                </div>
                <input type="range" min="0" max="100" value="50" style="width:100%; margin-top:15px;" oninput="moveSlider(this.value)">
            </div>
            <div class="card">
                <h3>EVOLUCI√ìN PESO</h3>
                <div style="height:200px;"><canvas id="weightChart"></canvas></div>
                <button class="btn-outline" onclick="addWeightEntry()">+ REGISTRAR PESO</button>
            </div>
            <div class="card">
                <h3>AJUSTES</h3>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>Sonido</span><label class="switch"><input type="checkbox" id="cfg-sound" checked><span class="slider"></span></label>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Pantalla Activa</span><label class="switch"><input type="checkbox" id="cfg-wake" checked><span class="slider"></span></label>
                </div>
            </div>
            <button class="btn-outline" style="border-color:#500; color:#f55; margin-bottom:20px;" onclick="logout()">CERRAR SESI√ìN</button>
        </section>

        <section id="workout-view" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; position:sticky; top:0; background:var(--bg-color); z-index:10; padding:10px 0;">
                <button onclick="switchTab('routines-view')" style="background:none; border:none; color:#666;">‚úï</button>
                <span id="mini-timer" style="color:var(--accent-color); font-weight:bold;">00:00</span>
                <button class="btn" style="width:auto; padding:5px 15px; font-size:0.8rem;" onclick="finishWorkoutPrompt()">TERMINAR</button>
            </div>
            <h2 id="workout-title">Entreno</h2>
            <div id="workout-exercises"></div>
        </section>

        <section id="admin-view" class="view-container">
            <h2>PANEL COACH</h2>
            <div class="card">
                <h3>Atletas</h3>
                <div id="admin-list"></div>
            </div>
            <button class="btn-outline" onclick="switchTab('routines-view')">VOLVER</button>
        </section>

    </main>

    <nav class="bottom-nav hidden" id="bottom-nav">
        <div class="nav-item active" onclick="switchTab('routines-view')">
            <span class="nav-icon">üèãÔ∏è</span><span>Rutinas</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile-view')">
            <span class="nav-icon">‚öôÔ∏è</span><span>Perfil</span>
        </div>
    </nav>

    <div id="modal-timer" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--success-color)">DESCANSO</h3>
            <div id="timer-display" style="font-size:4rem; font-weight:bold; color:white;">60</div>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                <button class="btn-outline" onclick="addTime(20)">+20s</button>
                <button class="btn" onclick="closeTimer()">OMITIR</button>
            </div>
        </div>
    </div>

    <div id="modal-coach" class="modal">
        <div class="modal-content">
            <h3 id="coach-user-name">Usuario</h3>
            <p id="coach-user-email" style="color:#666; font-size:0.8rem; margin-bottom:15px;"></p>
            <select id="coach-routine-select"></select>
            <button class="btn" style="margin-top:10px;" onclick="assignRoutine()">ASIGNAR RUTINA</button>
            <button class="btn-outline" onclick="document.getElementById('modal-coach').classList.remove('active')">CERRAR</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, addDoc, deleteDoc, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCmM0gViU3itZ4HIZZVTEm7OaV0iBtsiGs",
            authDomain: "fitdata-7a86b.firebaseapp.com",
            projectId: "fitdata-7a86b",
            storageBucket: "fitdata-7a86b.firebasestorage.app",
            messagingSenderId: "949628013924",
            appId: "1:949628013924:web:86278ae2c2bafb384d7e71"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN = "toni@fitdatapro.es";
        const CODE = "fityhab";

        // BASE DE DATOS (Las im√°genes que faltan usar√°n logo.png si fallan)
        const EXERCISES = [
            // PIERNAS
            {n:"Sentadilla con Barra", img:"cuadriceps.png"}, {n:"Sentadilla Jaca", img:"cuadriceps.png"}, {n:"Sentadilla Cintur√≥n", img:"cuadriceps.png"},
            {n:"Prensa de Piernas", img:"cuadriceps.png"}, {n:"Extensi√≥n Cu√°driceps", img:"cuadriceps.png"}, {n:"Zancadas Mancuernas", img:"cuadriceps.png"},
            {n:"Curl Femoral Tumbado", img:"isquiotibiales.png"}, {n:"Curl Femoral Sentado", img:"isquiotibiales.png"}, {n:"Prensa Horizontal", img:"cuadriceps.png"},
            {n:"Prensa 45 Grados", img:"cuadriceps.png"}, {n:"Gemelo Sentado", img:"gemelos.png"}, {n:"Gemelo de Pie", img:"gemelos.png"},
            {n:"Gemelo M√°quina", img:"gemelos.png"}, {n:"Hip Thrust", img:"gluteos.png"}, {n:"Sentadilla B√∫lgara", img:"gluteos.png"},
            {n:"Patada Gl√∫teo Polea", img:"gluteos.png"}, {n:"Abducci√≥n M√°quina", img:"gluteos.png"}, {n:"Prensa Gl√∫teos", img:"gluteos.png"},
            {n:"Peso Muerto Rumano", img:"isquiotibiales.png"},
            // ESPALDA
            {n:"Peso Muerto", img:"espalda.png"}, {n:"Peso Muerto Sumo", img:"espalda.png"}, {n:"Remo con Barra", img:"espalda.png"},
            {n:"Remo Mancuernas", img:"espalda.png"}, {n:"Jal√≥n al Pecho", img:"espalda.png"}, {n:"Jal√≥n Cerrado", img:"espalda.png"},
            {n:"Remo en M√°quina", img:"espalda.png"}, {n:"Remo Polea Baja", img:"espalda.png"}, {n:"Dominadas", img:"espalda.png"},
            {n:"Dominadas Asistidas", img:"espalda.png"}, {n:"Remo Invertido", img:"espalda.png"}, {n:"Remo T", img:"espalda.png"},
            {n:"Hiperextensiones", img:"espalda.png"}, {n:"Buenos D√≠as", img:"isquiotibiales.png"}, {n:"Remo Hammer", img:"espalda.png"},
            {n:"Jal√≥n Neutro", img:"espalda.png"}, {n:"Jal√≥n Abierto", img:"espalda.png"}, {n:"Remo al Cuello", img:"espalda.png"},
            // PECHO
            {n:"Press Banca", img:"pecho.png"}, {n:"Press Inclinado Mancuernas", img:"pecho.png"}, {n:"Aperturas Mancuernas", img:"pecho.png"},
            {n:"Cruce de Poleas", img:"pecho.png"}, {n:"Press M√°quina", img:"pecho.png"}, {n:"Press Declinado", img:"pecho.png"},
            {n:"Fondos", img:"triceps.png"}, {n:"Contractora Pecho", img:"pecho.png"}, {n:"Press Inclinado Barra", img:"pecho.png"},
            {n:"Press Plano Mancuernas", img:"pecho.png"}, {n:"Press Iso Lateral", img:"pecho.png"}, {n:"Press Vertical", img:"pecho.png"},
            // HOMBROS
            {n:"Encogimientos Barra", img:"hombros.png"}, {n:"Encogimientos Mancuerna", img:"hombros.png"}, {n:"Press Militar", img:"hombros.png"},
            {n:"Press Hombro Mancuerna", img:"hombros.png"}, {n:"Press Hombro M√°quina", img:"hombros.png"}, {n:"Elevaciones Laterales", img:"hombros.png"},
            {n:"Elevaciones Frontales", img:"hombros.png"}, {n:"P√°jaros", img:"hombros.png"}, {n:"Laterales Polea", img:"hombros.png"},
            {n:"Press Arnold", img:"hombros.png"}, {n:"Press Trasnuca", img:"hombros.png"}, {n:"Face Pull", img:"hombros.png"},
            // BRAZOS
            {n:"Curl Barra", img:"biceps.png"}, {n:"Curl Mancuernas", img:"biceps.png"}, {n:"Curl Polea", img:"biceps.png"},
            {n:"Curl Martillo", img:"biceps.png"}, {n:"Curl Concentrado", img:"biceps.png"}, {n:"Curl Predicador", img:"biceps.png"},
            {n:"Extensi√≥n Polea", img:"triceps.png"}, {n:"Press Franc√©s", img:"triceps.png"}, {n:"Rompecr√°neos", img:"triceps.png"},
            {n:"Fondos Tr√≠ceps", img:"triceps.png"}, {n:"Extensi√≥n Unilateral", img:"triceps.png"}, {n:"Patada Tr√≠ceps", img:"triceps.png"},
            {n:"Copa Tr√≠ceps", img:"triceps.png"},
            // ABS
            {n:"Rueda Abdominal", img:"abs.png"}, {n:"Crunch Polea", img:"abs.png"}, {n:"Elevaci√≥n Piernas", img:"abs.png"},
            {n:"Abdominales Banco", img:"abs.png"}, {n:"Crunch M√°quina", img:"abs.png"}, {n:"Rodillas al Pecho", img:"abs.png"}
        ];

        let currentUser = null;
        let userData = null;
        let activeWorkout = null;
        let timerInt = null;
        let wakeLock = null;
        let chartInstance = null;
        let selectedUserCoach = null;

        // AUTH
        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                const snap = await getDoc(doc(db, "users", user.uid));
                if(snap.exists()) {
                    userData = snap.data();
                    if(userData.email === ADMIN) {
                        const b = document.getElementById('coach-btn');
                        b.classList.remove('hidden');
                        b.onclick = () => { loadAdminUsers(); switchTab('admin-view'); };
                    }
                    if(userData.approved) {
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('main-header').classList.remove('hidden');
                        document.getElementById('bottom-nav').classList.remove('hidden');
                        loadRoutines();
                        switchTab('routines-view');
                    } else {
                        alert("Cuenta en revisi√≥n.");
                        signOut(auth);
                    }
                }
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
                switchTab('auth-view');
                document.getElementById('main-header').classList.add('hidden');
                document.getElementById('bottom-nav').classList.add('hidden');
            }
        });

        // NAVEGACION
        window.switchTab = (tab) => {
            document.querySelectorAll('.view-container').forEach(e => e.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.getElementById('main-container').scrollTop = 0;
            const ns = document.querySelectorAll('.nav-item');
            ns.forEach(n => n.classList.remove('active'));
            if(tab === 'routines-view') ns[0].classList.add('active');
            if(tab === 'profile-view') {
                ns[1].classList.add('active');
                loadProfile();
            }
        };
        window.toggleAuth = (m) => {
            document.getElementById('login-form').classList.toggle('hidden', m !== 'login');
            document.getElementById('register-form').classList.toggle('hidden', m !== 'register');
        };
        window.logout = () => signOut(auth).then(() => location.reload());

        // RUTINAS
        async function loadRoutines() {
            const list = document.getElementById('routines-list');
            list.innerHTML = 'Cargando...';
            const q = query(collection(db, "routines"));
            const snap = await onSnapshot(q, (s) => {
                list.innerHTML = '';
                s.forEach(d => {
                    const r = d.data();
                    if(r.uid === currentUser.uid || (r.assignedTo && r.assignedTo.includes(currentUser.uid))) {
                        const isMine = r.uid === currentUser.uid;
                        const div = document.createElement('div');
                        div.className = 'card';
                        div.innerHTML = `
                            <div style="display:flex; justify-content:space-between;">
                                <h3 style="color:${isMine?'white':'var(--accent-color)'}">${r.name}</h3>
                                ${isMine ? `<button style="background:none;border:none;" onclick="delRoutine('${d.id}')">üóëÔ∏è</button>` : 'üîí'}
                            </div>
                            <p style="color:#666; font-size:0.8rem; margin:10px 0;">${r.exercises.length} Ejercicios</p>
                            <button class="btn" onclick="startWorkout('${d.id}')">ENTRENAR</button>
                        `;
                        list.appendChild(div);
                    }
                });
            });
        }

        // EDITOR (CON FALLBACK DE IMAGEN)
        window.openRoutineEditor = () => {
            document.getElementById('editor-name').value = '';
            document.getElementById('ex-search').value = '';
            renderExercises(EXERCISES);
            switchTab('editor-view');
        };

        window.filterExercises = (term) => {
            const t = term.toLowerCase();
            const filtered = EXERCISES.filter(e => e.n.toLowerCase().includes(t));
            renderExercises(filtered);
        };

        function renderExercises(list) {
            const c = document.getElementById('exercise-selector-list');
            c.innerHTML = '';
            list.forEach(ex => {
                const div = document.createElement('div');
                div.className = 'ex-select-item';
                // El atributo onerror es la clave: si falla, usa el logo
                div.innerHTML = `<img src="${ex.img}" alt="img" onerror="this.src='logo.png'"><span>${ex.n}</span>`;
                div.onclick = () => {
                    div.classList.toggle('selected');
                };
                c.appendChild(div);
            });
        }

        window.saveRoutine = async () => {
            const name = document.getElementById('editor-name').value;
            const sel = Array.from(document.querySelectorAll('.ex-select-item.selected')).map(e => e.innerText);
            if(!name || sel.length===0) return alert("Faltan datos");
            await addDoc(collection(db, "routines"), {
                uid: currentUser.uid, name: name, exercises: sel, createdAt: serverTimestamp()
            });
            switchTab('routines-view');
        };
        window.delRoutine = async (id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db, "routines", id)); };

        // PERFIL
        async function loadProfile() {
            document.getElementById('profile-name').innerText = userData.name;
            if(userData.photo) {
                document.getElementById('avatar-text').style.display='none';
                document.getElementById('avatar-img').src = userData.photo;
                document.getElementById('avatar-img').style.display='block';
            }
            // Heatmap Random
            const muscles = ["Pecho","Espalda","Cu√°driceps","Isquios","Gl√∫teos","Hombros","B√≠ceps","Tr√≠ceps"];
            const hC = document.getElementById('heatmap-container');
            hC.innerHTML = '';
            muscles.forEach(m => {
                const pct = Math.floor(Math.random()*90)+10;
                const d = document.createElement('div');
                d.className = 'muscle-bar-group';
                d.innerHTML = `
                    <div class="muscle-label"><span>${m}</span><span>${pct}%</span></div>
                    <div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>
                `;
                hC.appendChild(d);
            });
            // Chart
            const ctx = document.getElementById('weightChart');
            if(chartInstance) chartInstance.destroy();
            const data = userData.weightHistory || [70,70.5,71];
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map((_,i)=>`T${i}`),
                    datasets: [{label:'Kg', data:data, borderColor:'#ff3333', backgroundColor:'rgba(255,51,51,0.1)', fill:true, tension:0.4}]
                },
                options: { plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{grid:{color:'#333'}}}, maintainAspectRatio:false }
            });
        }

        window.uploadAvatar = (inp) => {
            if(inp.files[0]) {
                const r = new FileReader();
                r.onload = async (e) => {
                    const b64 = e.target.result;
                    document.getElementById('avatar-img').src = b64;
                    document.getElementById('avatar-img').style.display = 'block';
                    document.getElementById('avatar-text').style.display = 'none';
                    await updateDoc(doc(db,"users",currentUser.uid), { photo: b64 });
                };
                r.readAsDataURL(inp.files[0]);
            }
        };

        window.loadCompImg = (inp, id) => {
            if(inp.files[0]) {
                const r = new FileReader();
                r.onload = (e) => document.getElementById(id).src = e.target.result;
                r.readAsDataURL(inp.files[0]);
            }
        };
        window.moveSlider = (val) => {
            document.getElementById('img-overlay').style.clipPath = `inset(0 ${100-val}% 0 0)`;
            document.getElementById('slider-handle').style.left = `${val}%`;
        };
        
        window.addWeightEntry = async () => {
            const w = prompt("Peso (kg):");
            if(w) {
                let h = userData.weightHistory || [];
                h.push(parseFloat(w));
                await updateDoc(doc(db,"users",currentUser.uid),{weightHistory:h});
                userData.weightHistory = h;
                loadProfile();
            }
        };

        // WORKOUT
        window.startWorkout = async (rid) => {
            if(document.getElementById('cfg-wake').checked && 'wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch(e){}
            }
            const snap = await getDoc(doc(db,"routines",rid));
            const r = snap.data();
            activeWorkout = { name: r.name, exs: r.exercises.map(n => {
                const img = EXERCISES.find(e=>e.n===n)?.img || 'logo.png';
                return { n:n, img:img, sets:Array(5).fill().map((_,i)=>({r:i===0?20:16, w:'', d:false})) };
            })};
            
            const c = document.getElementById('workout-exercises');
            c.innerHTML = '';
            document.getElementById('workout-title').innerText = activeWorkout.name;
            activeWorkout.exs.forEach((e,i) => {
                const card = document.createElement('div');
                card.className = 'card'; card.style.borderLeft="3px solid var(--accent-color)";
                let sH = '';
                e.sets.forEach((s,j) => {
                    sH += `<div class="set-row"><span>${j+1}</span><input type="number" placeholder="kg" onchange="uS(${i},${j},'w',this.value)"><input type="number" value="${s.r}" onchange="uS(${i},${j},'r',this.value)"><button class="${s.d?'btn':'btn-outline'}" style="margin:0;padding:0;height:35px;background:${s.d?'#0f8':'transparent'};color:${s.d?'#000':'#ccc'}" onclick="tS(${i},${j})">${s.d?'‚úì':''}</button></div>`;
                });
                // Fallback en la imagen del entreno
                card.innerHTML = `<div class="exercise-visual"><img src="${e.img}" alt="ex" onerror="this.src='logo.png'"></div><h3>${e.n}</h3>${sH}`;
                c.appendChild(card);
            });
            switchTab('workout-view');
            startTimerMini();
        };

        window.uS = (i,j,k,v) => activeWorkout.exs[i].sets[j][k]=v;
        window.tS = (i,j) => {
            const s = activeWorkout.exs[i].sets[j];
            s.d = !s.d;
            window.startWorkout(null); 
            const btn = document.querySelectorAll('.card')[i].querySelectorAll('button')[j];
            btn.className = s.d ? 'btn' : 'btn-outline';
            btn.style.background = s.d ? '#0f8' : 'transparent';
            btn.style.color = s.d ? '#000' : '#ccc';
            btn.innerText = s.d ? '‚úì' : '';
            if(s.d) openRest();
        };

        function startTimerMini() {
            const d = document.getElementById('mini-timer');
            const start = Date.now();
            setInterval(() => {
                const diff = Math.floor((Date.now()-start)/1000);
                d.innerText = `${Math.floor(diff/60)}:${(diff%60).toString().padStart(2,'0')}`;
            }, 1000);
        }

        function openRest() {
            const m = document.getElementById('modal-timer');
            m.classList.add('active');
            let t = 60;
            document.getElementById('timer-display').innerText = t;
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                t--; document.getElementById('timer-display').innerText = t;
                if(t<=0) {
                    clearInterval(timerInt); m.classList.remove('active');
                    if(document.getElementById('cfg-sound').checked) navigator.vibrate([200,100,200]);
                }
            }, 1000);
        }
        window.closeTimer = () => { clearInterval(timerInt); document.getElementById('modal-timer').classList.remove('active'); };
        window.addTime = (s) => { /* Visual */ };

        window.finishWorkoutPrompt = async () => {
            if(confirm("¬øGuardar?")) {
                await addDoc(collection(db,"workouts"), {uid:currentUser.uid, date:serverTimestamp(), routine:activeWorkout.name});
                if(wakeLock) wakeLock.release();
                switchTab('routines-view');
            }
        };

        // ADMIN
        async function loadAdminUsers() {
            const l = document.getElementById('admin-list');
            l.innerHTML = '';
            const snap = await getDocs(collection(db,"users"));
            snap.forEach(d => {
                const u = d.data();
                if(u.email === ADMIN) return;
                const div = document.createElement('div');
                div.style.cssText = "padding:10px; border-bottom:1px solid #333; display:flex; justify-content:space-between; cursor:pointer;";
                div.innerHTML = `<span>${u.name} <br><small>${u.approved?'OK':'Pendiente'}</small></span><span>${u.approved?'üü¢':'‚ö†Ô∏è'}</span>`;
                div.onclick = () => openCoachModal(d.id, u);
                l.appendChild(div);
            });
        }
        
        async function openCoachModal(uid, u) {
            selectedUserCoach = uid;
            const m = document.getElementById('modal-coach');
            document.getElementById('coach-user-name').innerText = u.name;
            document.getElementById('coach-user-email').innerText = u.email;
            if(!u.approved && confirm("¬øAprobar usuario?")) {
                await updateDoc(doc(db,"users",uid),{approved:true});
                loadAdminUsers();
            }
            const sel = document.getElementById('coach-routine-select');
            sel.innerHTML = '';
            const rS = await getDocs(collection(db,"routines"));
            rS.forEach(r => {
                const opt = document.createElement('option');
                opt.value = r.id; opt.innerText = r.data().name;
                sel.appendChild(opt);
            });
            m.classList.add('active');
        }

        window.assignRoutine = async () => {
            const rid = document.getElementById('coach-routine-select').value;
            if(!rid || !selectedUserCoach) return;
            const rRef = doc(db,"routines",rid);
            const rSnap = await getDoc(rRef);
            let arr = rSnap.data().assignedTo || [];
            if(!arr.includes(selectedUserCoach)) {
                arr.push(selectedUserCoach);
                await updateDoc(rRef, {assignedTo: arr});
                alert("Asignada");
            }
            document.getElementById('modal-coach').classList.remove('active');
        };

        // EVENTOS AUTH
        document.getElementById('btn-login').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value).catch(e=>alert(e.message));
        document.getElementById('btn-register').onclick = async () => {
            if(document.getElementById('reg-code').value !== CODE) return alert("C√≥digo mal");
            try {
                const c = await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-pass').value);
                await setDoc(doc(db,"users",c.user.uid), {
                    name: document.getElementById('reg-name').value, email: document.getElementById('reg-email').value,
                    approved: document.getElementById('reg-email').value === ADMIN
                });
            } catch(e) { alert(e.message); }
        };

    </script>
</body>
</html>
