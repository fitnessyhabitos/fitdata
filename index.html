<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Fit Data">
    <meta name="theme-color" content="#050505">

    <title>Fit Data | High Performance</title>
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="logo.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <style>
        /* --- VARIABLES GLOBALES --- */
        :root {
            --bg-color: #050505; --card-color: #121212; --input-bg: #1f1f1f; --text-color: #ffffff;
            --text-dim: #888888; --accent-color: #ff3333; --accent-dim: rgba(255, 51, 51, 0.2);
            --accent-glow: 0 0 15px rgba(255, 51, 51, 0.6); --success-color: #00ff88; --warning-color: #ffaa00;
            --font-main: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --safe-top: env(safe-area-inset-top, 20px); --safe-bottom: env(safe-area-inset-bottom, 20px);
            --header-height: 60px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        /* IOS SCROLL FIX */
        body {
            background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-main);
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100%;
            overflow: hidden; display: flex; flex-direction: column; overscroll-behavior: none;
        }

        .hidden { display: none !important; }

        /* UI KIT */
        .btn { background: var(--accent-color); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; width: 100%; box-shadow: var(--accent-glow); display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: transparent; border: 1px solid #444; color: #ccc; padding: 12px; width: 100%; border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px; font-size: 0.85rem; }
        .btn-small { padding: 6px 12px; font-size: 0.75rem; width: auto; margin:0; }
        .btn-danger { background: #600; border: 1px solid #f00; color: #fcc; margin-top: 15px; }
        .btn-success { background: var(--success-color); color: black; border: none; margin-bottom: 15px; box-shadow: 0 0 15px rgba(0,255,136,0.4); }
        .btn-done { background-color: rgba(255, 51, 51, 0.3) !important; border: 1px solid var(--accent-color) !important; color: white !important; box-shadow: 0 0 10px rgba(255, 51, 51, 0.4); }

        /* LOADING */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #loading-logo { width: 140px; border-radius: 25px; box-shadow: 0 0 40px rgba(255, 51, 51, 0.6); animation: breathe 3s infinite; clip-path: inset(0 round 25px); }
        .loading-text { margin-top: 30px; color: var(--accent-color); font-family: monospace; font-size: 1.1rem; letter-spacing: 4px; font-weight: bold; text-shadow: 0 0 10px var(--accent-color); animation: blink 0.8s infinite; }
        @keyframes breathe { 0%, 100% { transform: scale(1); opacity: 1; box-shadow: 0 0 50px rgba(255,51,51,0.7); } 50% { transform: scale(1.05); opacity: 0.8; box-shadow: 0 0 20px rgba(255,51,51,0.3); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* LAYOUT */
        header { flex-shrink: 0; height: calc(var(--header-height) + var(--safe-top)); padding-top: var(--safe-top); background: rgba(5,5,5,0.98); border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; padding-left: 20px; padding-right: 20px; z-index: 100; }
        .brand { font-weight: 900; font-size: 1.3rem; color: white; letter-spacing: -0.5px; }
        .brand span { color: var(--accent-color); text-shadow: 0 0 10px rgba(255,51,51,0.5); }
        .btn-neon-text { background: transparent; border: 1px solid var(--accent-color); color: var(--accent-color); font-weight: 800; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; letter-spacing: 1px; }

        #main-container { flex: 1; overflow-y: auto; position: relative; -webkit-overflow-scrolling: touch; padding-bottom: 20px; }
        .view-container { min-height: 100%; padding: 20px 15px 120px 15px; display: none; opacity: 0; animation: fadeIn 0.3s forwards; }
        .view-container.active { display: block; opacity: 1; }
        @keyframes fadeIn { to { opacity: 1; } }

        .card { background: var(--card-color); border-radius: 12px; padding: 18px; margin-bottom: 18px; border: 1px solid #222; position: relative; }
        input, select, textarea { background: var(--input-bg); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; width: 100%; margin-bottom: 12px; font-size: 16px; font-family: var(--font-main); }
        input:focus { outline: 1px solid var(--accent-color); }

        .profile-header { display: flex; align-items: center; gap: 20px; margin-bottom: 25px; }
        .avatar-circle { width: 75px; height: 75px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; border: 2px solid var(--accent-color); overflow: hidden; box-shadow: 0 0 10px rgba(255,51,51,0.2); }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        
        .muscle-bar-group { margin-bottom: 8px; }
        .muscle-label { display: flex; justify-content: space-between; font-size: 0.75rem; color: #ccc; margin-bottom: 3px; }
        .progress-track { width: 100%; height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent-color); width: 0%; transition: width 1s ease; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .stat-box { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; padding: 10px; text-align: center; }
        .stat-num { font-size: 1.2rem; font-weight: 800; color: white; display: block; }
        .stat-label { font-size: 0.7rem; color: #888; text-transform: uppercase; }

        .workout-split { display: grid; grid-template-columns: 80px 1fr; gap: 15px; margin-bottom: 15px; align-items: center; }
        .workout-visual { width: 80px; height: 80px; background: #000; border-radius: 8px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; padding: 5px; }
        .workout-visual img { width: 100%; height: 100%; object-fit: contain; }
        .workout-bars { display: flex; flex-direction: column; gap: 6px; width: 100%; }
        .mini-bar-label { font-size: 0.65rem; color: #888; display: flex; justify-content: space-between; margin-bottom: 2px; }
        .mini-track { width: 100%; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .mini-fill { height: 100%; border-radius: 2px; }
        .fill-primary { background: var(--accent-color); width: 100%; }
        .fill-sec { background: var(--warning-color); width: 50%; }
        .set-header { display: grid; grid-template-columns: 25px 1fr 1fr 45px; gap: 10px; font-size: 0.7rem; color: #666; margin-bottom: 5px; text-align: center; }
        .set-row { display: grid; grid-template-columns: 25px 1fr 1fr 45px; gap: 10px; align-items: center; margin-bottom: 10px; }
        .set-num { font-size: 0.85rem; color: #666; font-weight: bold; text-align: center; }
        .shadow-val { display: block; font-size: 0.65rem; color: #555; text-align: center; margin-bottom: 2px; }
        .sets-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 5px; }
        .btn-set-control { background: #222; border: 1px solid #444; color: #888; padding: 2px 8px; font-size: 0.7rem; border-radius: 4px; }

        .sticky-editor-header { position: sticky; top: -20px; background: var(--bg-color); z-index: 50; padding: 20px 0 10px 0; border-bottom: 1px solid #222; margin-top: -20px; margin-bottom: 15px; }
        .ex-select-item { display: flex; align-items: center; gap: 15px; padding: 12px; background: #1a1a1a; margin-bottom: 6px; border-radius: 8px; cursor: pointer; border: 1px solid transparent; }
        .ex-select-item img { width: 45px; height: 45px; object-fit: contain; background: black; border: 1px solid #333; border-radius: 4px; }
        .ex-select-item.selected { border-color: var(--accent-color); background: rgba(255,51,51,0.1); }
        .selected-summary { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .summary-pill { background: var(--accent-color); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; display: flex; align-items: center; gap: 5px; }
        .summary-pill span { cursor: pointer; font-weight: bold; }

        nav.bottom-nav { flex-shrink: 0; height: calc(60px + var(--safe-bottom)); padding-bottom: var(--safe-bottom); box-sizing: border-box; background: #0f0f0f; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 999; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #555; font-size: 0.65rem; height: 100%; }
        .nav-item.active { color: var(--accent-color); }
        .nav-icon { font-size: 1.5rem; margin-bottom: 3px; }

        .btn-float { position: fixed; bottom: 100px; right: 20px; width: 60px; height: 60px; border-radius: 50%; background: var(--accent-color); color: white; display: grid; place-items: center; font-size: 28px; box-shadow: 0 5px 20px rgba(255,51,51,0.6); z-index: 1000; cursor: pointer; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1a1a1a; width: 90%; max-width: 400px; padding: 25px; border-radius: 15px; border: 1px solid var(--accent-color); text-align: center; max-height: 85vh; overflow-y: auto; }

        .switch { position: relative; display: inline-block; width: 46px; height: 24px; } .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); } input:checked + .slider:before { transform: translateX(22px); }

        .compare-wrapper { position: relative; width: 100%; height: 250px; background: black; border-radius: 8px; overflow: hidden; margin-top: 5px; border:1px solid #333; }
        .compare-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; }
        .img-overlay { clip-path: inset(0 100% 0 0); border-right: 2px solid white; }
        .slider-handle { position: absolute; top: 0; bottom: 0; left: 50%; width: 2px; cursor: ew-resize; z-index: 10; background: rgba(255,255,255,0.5); }
        .slider-btn { display: none; }

        .admin-user-row { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .coach-photos-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .coach-photo-box { width: 45%; height: 150px; background: #000; border: 1px solid #333; border-radius: 8px; overflow: hidden; display: flex; align-items: center; justify-content: center; position:relative; }
        .coach-photo-box img { width: 100%; height: 100%; object-fit: contain; }
        .photo-date-label { position:absolute; bottom:0; left:0; width:100%; background:rgba(0,0,0,0.7); font-size:0.6rem; color:white; padding:2px 0; text-align:center; }
        .assigned-routine-item { background: #222; padding: 10px; margin-bottom: 5px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; border:1px solid #333; }
        .history-row { display: grid; grid-template-columns: 60px 1fr 20px 80px; border-bottom: 1px solid #333; padding: 10px 0; align-items: center; font-size: 0.75rem; text-align: left; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; text-transform: uppercase; text-align: center; }
        .badge.green { background: rgba(46, 125, 50, 0.3); color: #4caf50; border: 1px solid #2e7d32; }
        .badge.orange { background: rgba(245, 127, 23, 0.3); color: #ffb74d; border: 1px solid #f57f17; }
        .badge.red { background: rgba(198, 40, 40, 0.3); color: #ef5350; border: 1px solid #c62828; }
        .badge.gray { background: #333; color: #aaa; }
        .stat-pill-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; text-align: center; }
        .stat-pill { background: #111; border: 1px solid #333; padding: 8px 4px; border-radius: 6px; }
        .stat-pill b { display: block; font-size: 1rem; color: var(--accent-color); }
        .stat-pill span { font-size: 0.65rem; color: #888; text-transform: uppercase; }
        .photo-tabs { display: flex; margin-bottom: 10px; background: #222; border-radius: 8px; padding: 2px; }
        .photo-tab { flex: 1; text-align: center; padding: 10px; font-size: 0.8rem; cursor: pointer; color: #888; border-radius: 6px; }
        .photo-tab.active { background: var(--accent-color); color: white; font-weight: bold; }
        .photo-actions { display: grid; grid-template-columns: 1fr 40px 1fr 40px; gap: 5px; margin-top: 15px; }
        .rpe-btn { width: 100%; margin-bottom: 10px; border: none; padding: 15px; border-radius: 8px; color: white; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .rpe-easy { background: #2e7d32; } .rpe-hard { background: #f57f17; color: black; } .rpe-max { background: #c62828; }
        .note-icon { font-size: 1rem; cursor: pointer; }
        .tip-box { background: rgba(255, 170, 0, 0.15); border: 1px solid var(--warning-color); color: #ffcc80; padding: 10px; border-radius: 8px; font-size: 0.75rem; text-align: center; margin-bottom: 15px; }

    </style>
</head>
<body>

    <div id="loading-screen">
        <img src="logo.png" id="loading-logo" onerror="this.style.display='none'">
        <div class="loading-text">SYSTEM INITIALIZED</div>
    </div>

    <header id="main-header" class="hidden">
        <div class="brand">FIT DATA <span>PRO</span></div>
        <button id="coach-btn" class="hidden btn-neon-text">COACH</button>
    </header>

    <main id="main-container">
        <section id="auth-view" class="view-container">
            <div style="text-align:center; margin: 50px 0;">
                <img src="logo.png" style="width:110px; border-radius:20px; margin-bottom:15px;" onerror="this.src='https://placehold.co/100x100?text=FD'">
                <h1>ACCESO</h1>
            </div>
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-pass" placeholder="Contrase√±a">
                <button class="btn" id="btn-login">ENTRAR</button>
                <button class="btn-outline" onclick="toggleAuth('register')">CREAR CUENTA</button>
            </div>
            <div id="register-form" class="hidden">
                <input type="text" id="reg-name" placeholder="Nombre">
                <input type="email" id="reg-email" placeholder="Email">
                <input type="password" id="reg-pass" placeholder="Contrase√±a">
                <div style="display:flex; gap:10px;">
                    <input type="number" id="reg-age" placeholder="Edad">
                    <input type="number" id="reg-height" placeholder="Altura (cm)">
                </div>
                <input type="text" id="reg-code" placeholder="C√ìDIGO SECRETO">
                <button class="btn" id="btn-register">REGISTRARSE</button>
                <button class="btn-outline" onclick="toggleAuth('login')">VOLVER</button>
            </div>
        </section>

        <section id="routines-view" class="view-container">
            <h2>MIS RUTINAS</h2>
            <div id="routines-list"></div>
            <button class="btn-float" onclick="openEditor()">+</button>
        </section>

        <section id="editor-view" class="view-container">
            <div class="sticky-editor-header">
                <h2 id="editor-title">NUEVA RUTINA</h2>
                <div style="display:flex; gap:10px; margin-bottom:10px;">
                    <input type="text" id="editor-name" placeholder="Nombre de Rutina" style="margin:0;">
                    <button id="btn-save-routine" class="btn" style="width:auto; padding:0 25px;" onclick="window.saveRoutine()">GUARDAR</button>
                </div>
                <input type="search" id="ex-search" placeholder="üîç Buscar ejercicio..." oninput="filterExercises(this.value)" style="margin-bottom:0;">
                <div id="selected-summary" class="selected-summary"></div>
            </div>
            <div class="card">
                <div id="exercise-selector-list"></div>
            </div>
            <button class="btn-outline" style="border-color:#666;" onclick="switchTab('routines-view')">CANCELAR</button>
        </section>

        <section id="profile-view" class="view-container">
            <div class="profile-header">
                <div class="avatar-circle" onclick="document.getElementById('file-avatar').click()">
                    <img id="avatar-img" src="" style="display:none;">
                    <span id="avatar-text" style="font-size:1.5rem; color:var(--accent-color);">U</span>
                </div>
                <input type="file" id="file-avatar" accept="image/*" class="hidden" onchange="uploadAvatar(this)">
                <div>
                    <h3 id="profile-name" style="margin:0;">Cargando...</h3>
                    <span style="color:#666; font-size:0.8rem;">Atleta de Alto Rendimiento</span>
                </div>
            </div>

            <div class="card">
                <h3>ESTAD√çSTICAS TOTALES</h3>
                <div class="stats-grid">
                    <div class="stat-box"><span class="stat-num" id="stat-workouts">0</span><span class="stat-label">Entrenos</span></div>
                    <div class="stat-box"><span class="stat-num" id="stat-kg">0</span><span class="stat-label">Kg Movidos</span></div>
                    <div class="stat-box"><span class="stat-num" id="stat-sets">0</span><span class="stat-label">Series</span></div>
                    <div class="stat-box"><span class="stat-num" id="stat-reps">0</span><span class="stat-label">Reps</span></div>
                </div>
            </div>

            <div class="card">
                <h3>MAPA MUSCULAR (SERIES)</h3>
                <div id="heatmap-container"></div>
            </div>

            <div class="card">
                <h3>EVOLUCI√ìN F√çSICA</h3>
                <div class="tip-box">üí° TIP: Usa siempre la misma luz, ropa y lugar.</div>
                <div class="photo-tabs">
                    <div class="photo-tab active" id="tab-front" onclick="switchPose('front')">üë§ FRONTAL</div>
                    <div class="photo-tab" id="tab-back" onclick="switchPose('back')">üõ°Ô∏è ESPALDA</div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.7rem; color:#888;">
                    <span id="date-before">-</span>
                    <span id="date-after">-</span>
                </div>
                <div class="compare-wrapper">
                    <img src="" id="img-before" class="compare-img">
                    <img src="" id="img-overlay" class="compare-img img-overlay">
                    <div class="slider-handle" id="slider-handle"><div class="slider-btn"></div></div>
                </div>
                <input type="range" min="0" max="100" value="0" style="width:100%; margin-top:15px;" oninput="moveSlider(this.value)">
                <div class="photo-actions">
                    <button class="btn-outline" style="margin:0; padding:10px 5px;" onclick="document.getElementById('f-before').click()">1. ANTES</button>
                    <button class="btn-danger btn-small" style="margin:0;" onclick="deletePhoto('before')">üóëÔ∏è</button>
                    <button class="btn-outline" style="margin:0; padding:10px 5px;" onclick="document.getElementById('f-after').click()">2. AHORA</button>
                    <button class="btn-danger btn-small" style="margin:0;" onclick="deletePhoto('after')">üóëÔ∏è</button>
                </div>
                <input type="file" id="f-before" class="hidden" accept="image/*" onchange="loadCompImg(this,'before')">
                <input type="file" id="f-after" class="hidden" accept="image/*" onchange="loadCompImg(this,'after')">
            </div>

            <div class="card">
                <h3>CONFIGURACI√ìN & ALARMAS</h3>
                <div style="margin-bottom:15px;">
                    <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">Recordatorio Fotos:</div>
                    <div style="display:flex; gap:10px;">
                        <select id="photo-day" style="margin:0;">
                            <option value="1">Lunes</option><option value="2">Martes</option><option value="3">Mi√©rcoles</option>
                            <option value="4">Jueves</option><option value="5">Viernes</option><option value="6">S√°bado</option><option value="0">Domingo</option>
                        </select>
                        <input type="time" id="photo-time" value="09:00" style="margin:0;">
                        <button class="btn-small btn" onclick="savePhotoReminder()">OK</button>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                    <span>Sonido (5 Beeps)</span>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button class="btn-small btn-outline" style="margin:0; padding:2px 8px; font-size:0.7rem;" onclick="testSound()">üîä PROBAR</button>
                        <label class="switch"><input type="checkbox" id="cfg-sound" checked><span class="slider"></span></label>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between;">
                    <span>Pantalla Activa</span><label class="switch"><input type="checkbox" id="cfg-wake" checked><span class="slider"></span></label>
                </div>
                <button class="btn-outline" style="margin-top:15px;" onclick="saveConfig()">GUARDAR AJUSTES</button>
            </div>

            <div class="card">
                <h3>PESO CORPORAL</h3>
                <div style="position: relative; height: 200px; width: 100%;"><canvas id="weightChart"></canvas></div>
                <button class="btn-outline" onclick="addWeightEntry()">+ REGISTRAR HOY</button>
            </div>

            <button class="btn-outline" style="border-color:#500; color:#f55; margin-bottom:20px;" onclick="logout()">CERRAR SESI√ìN</button>
        </section>

        <section id="workout-view" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; position:sticky; top:0; background:var(--bg-color); z-index:10; padding:10px 0; border-bottom:1px solid #222;">
                <button onclick="switchTab('routines-view')" style="background:none; border:none; color:#666; font-size:1.5rem;">‚úï</button>
                <div style="text-align:center;">
                    <span style="font-size:0.6rem; color:#666;">TIEMPO</span><br>
                    <span id="mini-timer" style="color:var(--accent-color); font-weight:bold;">00:00</span>
                </div>
                <button class="btn-small btn" onclick="promptRPE()">TERMINAR</button>
            </div>
            <h2 id="workout-title" style="margin-bottom:20px;">Entreno</h2>
            <div id="workout-exercises"></div>
        </section>

        <section id="admin-view" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2>PANEL COACH</h2>
                <button class="btn-small btn-outline" style="width:auto; margin:0;" onclick="window.loadAdminUsers()">üîÑ ACTUALIZAR</button>
            </div>
            <div class="card">
                <h3>Lista de Atletas</h3>
                <div id="admin-list"></div>
            </div>
            <button class="btn-outline" onclick="switchTab('routines-view')">VOLVER</button>
        </section>

        <section id="coach-detail-view" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <button class="btn-outline btn-small" style="width:auto; margin:0;" onclick="switchTab('admin-view')">‚Üê VOLVER</button>
                <h3 style="margin:0;">FICHA ATLETA</h3>
            </div>

            <div style="text-align:center; margin-bottom:20px;">
                <div class="avatar-circle" style="width:80px; height:80px; margin:0 auto 10px auto;">
                    <img id="coach-user-img" src="" style="display:none;">
                    <span id="coach-user-initial" style="font-size:2rem; color:var(--accent-color);">U</span>
                </div>
                <h2 id="coach-user-name" style="margin:0;">Usuario</h2>
                <p id="coach-user-email" style="color:#666; font-size:0.8rem;"></p>
                
                <div id="pending-approval-banner" class="hidden" style="margin-top:15px;">
                    <button class="btn btn-success" onclick="window.approveUser()">‚úÖ APROBAR ACCESO</button>
                </div>
            </div>
            
            <div id="coach-stats-text" class="stat-pill-grid" style="margin-bottom:20px;"></div>

            <div class="card">
                <h3>üì∏ FOTOS PROGRESO</h3>
                <div class="photo-tabs">
                    <div class="photo-tab active" id="coach-tab-front" onclick="switchCoachPose('front')">FRONTAL</div>
                    <div class="photo-tab" id="coach-tab-back" onclick="switchCoachPose('back')">ESPALDA</div>
                </div>
                
                <div class="compare-wrapper">
                    <img src="" id="coach-img-before" class="compare-img">
                    <img src="" id="coach-img-overlay" class="compare-img img-overlay">
                    <div class="slider-handle" id="coach-slider-handle" style="left:0%"><div class="slider-btn"></div></div>
                </div>
                <input type="range" min="0" max="100" value="0" style="width:100%; margin-top:15px;" oninput="moveCoachSlider(this.value)">
                
                <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:0.7rem; color:#888;">
                    <span id="coach-date-before">ANTES</span>
                    <span id="coach-date-after">AHORA</span>
                </div>
            </div>

            <div class="card">
                <h3>GR√ÅFICA PESO</h3>
                <div style="height:200px; width:100%; position:relative;">
                    <canvas id="coachWeightChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h3>RUTINAS ASIGNADAS</h3>
                <div id="coach-assigned-list" style="font-size:0.8rem; color:#888; margin-bottom:15px;">Cargando...</div>

                <label style="font-size:0.7rem; color:#ccc; text-transform:uppercase;">Asignar Nueva:</label>
                <input type="text" placeholder="üîç Buscar rutina..." id="coach-routine-filter" style="margin-bottom:5px; padding:10px; font-size:0.9rem;" oninput="filterCoachRoutines(this.value)">
                
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <select id="coach-routine-select" style="margin:0;"></select>
                    <button class="btn-small btn-outline" style="width:auto; padding:0 15px;" onclick="goToCreateRoutine()">‚ûï CREAR</button>
                    <button class="btn-small btn" style="width:auto; padding:0 15px;" onclick="assignRoutine()">ENVIAR</button>
                </div>
            </div>

            <div class="card">
                <h3>HISTORIAL RECIENTE</h3>
                <div id="coach-history-list" style="max-height:300px; overflow-y:auto;"></div>
            </div>

            <button class="btn-danger btn" style="width:100%; margin-bottom:30px;" onclick="deleteUser()">üóëÔ∏è ELIMINAR ATLETA DEFINITIVAMENTE</button>
        </section>

    </main>

    <nav class="bottom-nav hidden" id="bottom-nav">
        <div class="nav-item active" onclick="switchTab('routines-view')">
            <span class="nav-icon">üèãÔ∏è</span><span>Rutinas</span>
        </div>
        <div class="nav-item" onclick="switchTab('profile-view')">
            <span class="nav-icon">‚öôÔ∏è</span><span>Perfil</span>
        </div>
    </nav>

    <div id="modal-timer" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--success-color)">DESCANSO</h3>
            <div id="timer-display" style="font-size:5rem; font-weight:900; color:white; margin:20px 0;">60</div>
            <div style="display:flex; gap:15px; justify-content:center;">
                <button class="btn-outline" onclick="addRestTime(20)">+20s</button>
                <button class="btn" onclick="closeTimer()">OMITIR</button>
            </div>
        </div>
    </div>

    <div id="modal-rpe" class="modal">
        <div class="modal-content">
            <h3>FINALIZAR ENTRENO</h3>
            <p style="color:#888; margin-bottom:20px;">¬øDificultad?</p>
            <button class="rpe-btn rpe-easy" onclick="finishWorkout('Suave')">üü¢ Suave / Moderado</button>
            <button class="rpe-btn rpe-hard" onclick="finishWorkout('Duro')">üü† Duro / Intenso</button>
            <button class="rpe-btn rpe-max" onclick="finishWorkout('Fallo')">üî¥ Fallo / Extremo</button>
            <textarea id="workout-notes" rows="3" placeholder="üìù Notas (opcional)..." style="width:100%; background:#222; border:1px solid #333; color:white; border-radius:8px; padding:10px; margin-top:10px; font-family:inherit;"></textarea>
            <button class="btn-outline" onclick="document.getElementById('modal-rpe').classList.remove('active')">Cancelar</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, addDoc, deleteDoc, getDocs, serverTimestamp, increment, orderBy, limit, arrayRemove, arrayUnion } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCmM0gViU3itZ4HIZZVTEm7OaV0iBtsiGs",
            authDomain: "fitdata-7a86b.firebaseapp.com",
            projectId: "fitdata-7a86b",
            storageBucket: "fitdata-7a86b.firebasestorage.app",
            messagingSenderId: "949628013924",
            appId: "1:949628013924:web:86278ae2c2bafb384d7e71"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const ADMIN = "toni@fitdatapro.es";
        const CODE = "fityhab";

        // AUDIO SYSTEM (5 BEEPS)
        let audioCtx = null;

        function unlockAudio() {
            if(!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if(audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            const buffer = audioCtx.createBuffer(1, 1, 22050);
            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            source.connect(audioCtx.destination);
            source.start(0);
        }
        document.addEventListener('touchstart', unlockAudio, {once:true});
        document.addEventListener('click', unlockAudio, {once:true});

        function play5Beeps() {
            if(!audioCtx) unlockAudio();
            if(audioCtx) {
                const now = audioCtx.currentTime;
                for(let i=0; i<5; i++) {
                    const osc = audioCtx.createOscillator();
                    const gain = audioCtx.createGain();
                    osc.type = 'square';
                    osc.frequency.value = 880; 
                    osc.connect(gain);
                    gain.connect(audioCtx.destination);
                    const start = now + (i * 0.6);
                    const end = start + 0.15;
                    osc.start(start);
                    osc.stop(end);
                    gain.gain.setValueAtTime(0.5, start);
                    gain.gain.exponentialRampToValueAtTime(0.01, end);
                }
            }
        }

        window.testSound = () => { play5Beeps(); };

        // BASE DE DATOS COMPLETA 82 EJERCICIOS
        const EXERCISES = [
            {n:"Sentadilla con Barra", img:"cuadriceps.png", m:"Cu√°driceps"}, {n:"Sentadilla Jaca", img:"cuadriceps.png", m:"Cu√°driceps"},
            {n:"Sentadilla Cintur√≥n", img:"cuadriceps.png", m:"Cu√°driceps"}, {n:"Prensa de Piernas", img:"cuadriceps.png", m:"Cu√°driceps"},
            {n:"Extensi√≥n Cu√°driceps", img:"cuadriceps.png", m:"Cu√°driceps"}, {n:"Zancadas Mancuernas", img:"cuadriceps.png", m:"Cu√°driceps"},
            {n:"Curl Femoral Tumbado", img:"isquiotibiales.png", m:"Isquios"}, {n:"Curl Femoral Sentado", img:"isquiotibiales.png", m:"Isquios"},
            {n:"Prensa Horizontal", img:"cuadriceps.png", m:"Cu√°driceps"}, {n:"Prensa 45 Grados", img:"cuadriceps.png", m:"Cu√°driceps"},
            {n:"Gemelo Sentado", img:"gemelos.png", m:"Gemelos"}, {n:"Gemelo de Pie", img:"gemelos.png", m:"Gemelos"},
            {n:"Gemelo M√°quina", img:"gemelos.png", m:"Gemelos"}, {n:"Hip Thrust", img:"gluteos.png", m:"Gl√∫teos"},
            {n:"Sentadilla B√∫lgara", img:"gluteos.png", m:"Gl√∫teos"}, {n:"Patada Gl√∫teo Polea", img:"gluteos.png", m:"Gl√∫teos"},
            {n:"Abducci√≥n M√°quina", img:"gluteos.png", m:"Gl√∫teos"}, {n:"Prensa Gl√∫teos", img:"gluteos.png", m:"Gl√∫teos"},
            {n:"Peso Muerto Rumano", img:"isquiotibiales.png", m:"Isquios"},
            {n:"Peso Muerto", img:"espalda.png", m:"Espalda"}, {n:"Peso Muerto Sumo", img:"espalda.png", m:"Espalda"},
            {n:"Remo con Barra", img:"espalda.png", m:"Espalda"}, {n:"Remo Mancuernas", img:"espalda.png", m:"Espalda"},
            {n:"Jal√≥n al Pecho", img:"espalda.png", m:"Espalda"}, {n:"Jal√≥n Cerrado", img:"espalda.png", m:"Espalda"},
            {n:"Remo en M√°quina", img:"espalda.png", m:"Espalda"}, {n:"Remo Polea Baja", img:"espalda.png", m:"Espalda"},
            {n:"Dominadas", img:"espalda.png", m:"Espalda"}, {n:"Dominadas Asistidas", img:"espalda.png", m:"Espalda"},
            {n:"Remo Invertido", img:"espalda.png", m:"Espalda"}, {n:"Remo T", img:"espalda.png", m:"Espalda"},
            {n:"Hiperextensiones", img:"espalda.png", m:"Espalda"}, {n:"Buenos D√≠as", img:"isquiotibiales.png", m:"Isquios"},
            {n:"Remo Hammer", img:"espalda.png", m:"Espalda"}, {n:"Jal√≥n Neutro", img:"espalda.png", m:"Espalda"},
            {n:"Jal√≥n Abierto", img:"espalda.png", m:"Espalda"}, {n:"Remo al Cuello", img:"espalda.png", m:"Espalda"},
            {n:"Press Banca", img:"pecho.png", m:"Pecho"}, {n:"Press Inclinado Mancuernas", img:"pecho.png", m:"Pecho"},
            {n:"Aperturas Mancuernas", img:"pecho.png", m:"Pecho"}, {n:"Cruce de Poleas", img:"pecho.png", m:"Pecho"},
            {n:"Press M√°quina", img:"pecho.png", m:"Pecho"}, {n:"Press Declinado", img:"pecho.png", m:"Pecho"},
            {n:"Fondos", img:"triceps.png", m:"Tr√≠ceps"}, {n:"Contractora Pecho", img:"pecho.png", m:"Pecho"},
            {n:"Press Inclinado Barra", img:"pecho.png", m:"Pecho"}, {n:"Press Plano Mancuernas", img:"pecho.png", m:"Pecho"},
            {n:"Press Iso Lateral", img:"pecho.png", m:"Pecho"}, {n:"Press Vertical", img:"pecho.png", m:"Pecho"},
            {n:"Encogimientos Barra", img:"hombros.png", m:"Hombros"}, {n:"Encogimientos Mancuerna", img:"hombros.png", m:"Hombros"},
            {n:"Press Militar", img:"hombros.png", m:"Hombros"}, {n:"Press Hombro Mancuerna", img:"hombros.png", m:"Hombros"},
            {n:"Press Hombro M√°quina", img:"hombros.png", m:"Hombros"}, {n:"Elevaciones Laterales", img:"hombros.png", m:"Hombros"},
            {n:"Elevaciones Frontales", img:"hombros.png", m:"Hombros"}, {n:"P√°jaros", img:"hombros.png", m:"Hombros"},
            {n:"Laterales Polea", img:"hombros.png", m:"Hombros"}, {n:"Press Arnold", img:"hombros.png", m:"Hombros"},
            {n:"Press Trasnuca", img:"hombros.png", m:"Hombros"}, {n:"Face Pull", img:"hombros.png", m:"Hombros"},
            {n:"Curl Barra", img:"biceps.png", m:"B√≠ceps"}, {n:"Curl Mancuernas", img:"biceps.png", m:"B√≠ceps"},
            {n:"Curl Polea", img:"biceps.png", m:"B√≠ceps"}, {n:"Curl Martillo", img:"biceps.png", m:"B√≠ceps"},
            {n:"Curl Concentrado", img:"biceps.png", m:"B√≠ceps"}, {n:"Curl Predicador", img:"biceps.png", m:"B√≠ceps"},
            {n:"Extensi√≥n Polea", img:"triceps.png", m:"Tr√≠ceps"}, {n:"Press Franc√©s", img:"triceps.png", m:"Tr√≠ceps"},
            {n:"Rompecr√°neos", img:"triceps.png", m:"Tr√≠ceps"}, {n:"Fondos Tr√≠ceps", img:"triceps.png", m:"Tr√≠ceps"},
            {n:"Extensi√≥n Unilateral", img:"triceps.png", m:"Tr√≠ceps"}, {n:"Patada Tr√≠ceps", img:"triceps.png", m:"Tr√≠ceps"},
            {n:"Copa Tr√≠ceps", img:"triceps.png", m:"Tr√≠ceps"},
            {n:"Rueda Abdominal", img:"abs.png", m:"Abs"}, {n:"Crunch Polea", img:"abs.png", m:"Abs"},
            {n:"Elevaci√≥n Piernas", img:"abs.png", m:"Abs"}, {n:"Abdominales Banco", img:"abs.png", m:"Abs"},
            {n:"Crunch M√°quina", img:"abs.png", m:"Abs"}, {n:"Rodillas al Pecho", img:"abs.png", m:"Abs"}
        ];

        let currentUser=null, userData=null, activeWorkout=null, timerInt=null, restTimeRemaining=0, wakeLock=null, chartInstance=null, selectedUserCoach=null, selectedUserObj=null, editingRoutineId=null, coachChart=null, currentPose='front', coachCurrentPose='front', allRoutinesCache=[], adminUnsub=null;
        
        // GLOBAL SELECTION STATE FOR EDITOR
        let currentRoutineSelections = [];

        function getExerciseData(name) {
            let match = EXERCISES.find(e => e.n === name);
            if (!match) {
                const cleanName = name.toLowerCase().replace(/ de | con | en | el | la /g, " ").trim();
                match = EXERCISES.find(e => {
                    const cleanDbName = e.n.toLowerCase().replace(/ de | con | en | el | la /g, " ").trim();
                    return cleanDbName.includes(cleanName) || cleanName.includes(cleanDbName);
                });
            }
            if (!match) {
                const n = name.toLowerCase();
                let m = "General", img = "logo.png";
                if(n.includes("press")||n.includes("pecho")||n.includes("aperturas")) { m="Pecho"; img="pecho.png"; }
                else if(n.includes("remo")||n.includes("jalon")||n.includes("espalda")||n.includes("dominadas")) { m="Espalda"; img="espalda.png"; }
                else if(n.includes("sentadilla")||n.includes("prensa")||n.includes("extension")||n.includes("zancada")) { m="Cu√°driceps"; img="cuadriceps.png"; }
                else if(n.includes("curl")||n.includes("biceps")) { m="B√≠ceps"; img="biceps.png"; }
                else if(n.includes("triceps")||n.includes("frances")||n.includes("fondos")) { m="Tr√≠ceps"; img="triceps.png"; }
                else if(n.includes("hombro")||n.includes("militar")||n.includes("elevacion")||n.includes("pajaros")) { m="Hombros"; img="hombros.png"; }
                return { img: img, mInfo: getMuscleInfoByGroup(m) };
            }
            return { img: match.img, mInfo: getMuscleInfoByGroup(match.m) };
        }

        function getMuscleInfoByGroup(m) {
            let s = [];
            if(m==="Pecho") s=["Tr√≠ceps","Hombros"]; 
            else if(m==="Espalda") s=["B√≠ceps", "Antebrazo"]; 
            else if(m==="Cu√°driceps") s=["Gl√∫teos", "Gemelos"]; 
            else if(m==="Isquios") s=["Gl√∫teos", "Espalda Baja"];
            else if(m==="Hombros") s=["Tr√≠ceps", "Trapecio"]; 
            else if(m==="B√≠ceps") s=["Antebrazo"];
            else if(m==="Tr√≠ceps") s=["Hombros", "Pecho"];
            else if(m==="Gl√∫teos") s=["Isquios", "Cu√°driceps"];
            return {main:m, sec:s};
        }

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                currentUser = user;
                const snap = await getDoc(doc(db,"users",user.uid));
                if(snap.exists()){
                    userData = snap.data();
                    checkPhotoReminder();
                    if(userData.email === ADMIN){
                        document.getElementById('coach-btn').classList.remove('hidden');
                        document.getElementById('coach-btn').onclick = () => { window.loadAdminUsers(); switchTab('admin-view'); };
                    }
                    if(userData.approved){
                        document.getElementById('loading-screen').classList.add('hidden');
                        document.getElementById('main-header').classList.remove('hidden');
                        document.getElementById('bottom-nav').classList.remove('hidden');
                        loadRoutines();
                        switchTab('routines-view');
                    } else { alert("Cuenta en revisi√≥n."); signOut(auth); }
                }
            } else {
                document.getElementById('loading-screen').classList.add('hidden');
                switchTab('auth-view');
                document.getElementById('main-header').classList.add('hidden');
                document.getElementById('bottom-nav').classList.add('hidden');
            }
        });

        function checkPhotoReminder() {
            if(!userData.photoDay) return;
            const now = new Date();
            const day = now.getDay();
            const time = now.toTimeString().substr(0,5);
            if(day == userData.photoDay && time === userData.photoTime) alert("üì∏ HORA DE TU FOTO DE PROGRESO üì∏");
        }

        window.switchTab = (t) => {
            document.querySelectorAll('.view-container').forEach(e=>e.classList.remove('active'));
            document.getElementById(t).classList.add('active');
            document.getElementById('main-container').scrollTop = 0;
            const ns = document.querySelectorAll('.nav-item');
            ns.forEach(n=>n.classList.remove('active'));
            if(t==='routines-view') ns[0].classList.add('active');
            if(t==='profile-view') { ns[1].classList.add('active'); loadProfile(); }
        };
        window.toggleAuth = (m) => { document.getElementById('login-form').classList.toggle('hidden',m!=='login'); document.getElementById('register-form').classList.toggle('hidden',m!=='register'); };
        window.logout = () => signOut(auth).then(()=>location.reload());

        async function loadRoutines() {
            const l = document.getElementById('routines-list'); l.innerHTML = 'Cargando...';
            onSnapshot(query(collection(db,"routines")), (s)=>{
                l.innerHTML = '';
                s.forEach(d=>{
                    const r = d.data();
                    if(r.uid===currentUser.uid || (r.assignedTo && r.assignedTo.includes(currentUser.uid))){
                        const isMine = r.uid===currentUser.uid;
                        const div = document.createElement('div');
                        div.className = 'card';
                        div.innerHTML = `<div style="display:flex; justify-content:space-between;"><h3 style="color:${isMine?'white':'var(--accent-color)'}">${r.name}</h3><div>${isMine ? `<button style="background:none;border:none;margin-right:10px;" onclick="openEditor('${d.id}')">‚úèÔ∏è</button><button style="background:none;border:none;" onclick="delRoutine('${d.id}')">üóëÔ∏è</button>` : 'üîí'}</div></div><p style="color:#666; font-size:0.8rem; margin:10px 0;">${r.exercises.length} Ejercicios</p><button class="btn" onclick="startWorkout('${d.id}')">ENTRENAR</button>`;
                        l.appendChild(div);
                    }
                });
            });
        }

        window.openEditor = async (id=null) => {
            editingRoutineId = id;
            document.getElementById('editor-name').value = '';
            document.getElementById('editor-title').innerText = id ? "EDITAR RUTINA" : "NUEVA RUTINA";
            currentRoutineSelections = [];
            
            if(id) {
                const docSnap = await getDoc(doc(db,"routines",id));
                const r = docSnap.data();
                document.getElementById('editor-name').value = r.name;
                currentRoutineSelections = r.exercises || [];
            }
            
            renderExercises(EXERCISES); 
            renderSelectedSummary();
            switchTab('editor-view');
        };

        window.filterExercises = (t) => {
            const filtered = EXERCISES.filter(e => e.n.toLowerCase().includes(t.toLowerCase()));
            renderExercises(filtered);
        };

        function renderExercises(l) {
            const c = document.getElementById('exercise-selector-list'); c.innerHTML = '';
            l.forEach(e => {
                const d = document.createElement('div'); 
                d.className = 'ex-select-item';
                if(currentRoutineSelections.includes(e.n)) d.classList.add('selected');
                
                d.innerHTML = `<img src="${e.img}" onerror="this.src='logo.png'"><span>${e.n}</span>`;
                
                d.onclick = () => {
                    if(currentRoutineSelections.includes(e.n)) {
                        currentRoutineSelections = currentRoutineSelections.filter(x => x !== e.n);
                        d.classList.remove('selected');
                    } else {
                        currentRoutineSelections.push(e.n);
                        d.classList.add('selected');
                    }
                    renderSelectedSummary();
                };
                c.appendChild(d);
            });
        }

        function renderSelectedSummary() {
            const div = document.getElementById('selected-summary');
            div.innerHTML = '';
            currentRoutineSelections.forEach(name => {
                const pill = document.createElement('div');
                pill.className = 'summary-pill';
                pill.innerHTML = `<span>${name}</span> <b onclick="removeSelection('${name}')">‚úï</b>`;
                div.appendChild(pill);
            });
        }
        
        window.removeSelection = (name) => {
            currentRoutineSelections = currentRoutineSelections.filter(x => x !== name);
            renderSelectedSummary();
            const searchVal = document.getElementById('ex-search').value;
            window.filterExercises(searchVal); 
        }

        window.saveRoutine = async () => {
            const n = document.getElementById('editor-name').value;
            const s = currentRoutineSelections;
            
            if(!n || s.length===0) return alert("‚ùå Faltan datos: Pon un nombre y elige ejercicios.");
            
            const btn = document.getElementById('btn-save-routine');
            const originalText = btn.innerText;
            btn.innerText = "üíæ GUARDANDO...";
            
            try {
                const data = { uid:currentUser.uid, name:n, exercises:s, createdAt:serverTimestamp() };
                if(editingRoutineId) await updateDoc(doc(db,"routines",editingRoutineId), {name:n, exercises:s});
                else await addDoc(collection(db,"routines"), data);
                
                switchTab('routines-view');
            } catch(e) {
                alert("Error al guardar: " + e.message);
            } finally {
                btn.innerText = originalText;
            }
        };
        
        window.delRoutine = async (id) => { if(confirm("¬øBorrar?")) await deleteDoc(doc(db,"routines",id)); };

        // --- PHOTO COMPARISON LOGIC ---
        window.switchPose = (pose) => {
            currentPose = pose;
            document.getElementById('tab-front').classList.toggle('active', pose==='front');
            document.getElementById('tab-back').classList.toggle('active', pose==='back');
            updatePhotoDisplay(userData); 
        };

        function updatePhotoDisplay(u) {
            const prefix = currentPose === 'front' ? '' : '_back';
            const before = u[`photoBefore${prefix}`] || '';
            const after = u[`photoAfter${prefix}`] || '';
            const dateB = u[`dateBefore${prefix}`] || '-';
            const dateA = u[`dateAfter${prefix}`] || '-';

            const imgB = document.getElementById('img-before');
            const imgA = document.getElementById('img-overlay');
            
            if(before) imgB.src = before; else imgB.removeAttribute('src');
            if(after) imgA.src = after; else imgA.removeAttribute('src');

            document.getElementById('date-before').innerText = `ANTES (${dateB})`;
            document.getElementById('date-after').innerText = `AHORA (${dateA})`;
            
            // Reset slider to 0 (Before)
            document.getElementById('slider-handle').style.left = '0%';
            imgA.style.clipPath = 'inset(0 100% 0 0)';
        }

        window.loadCompImg = (inp, field) => { 
            if(inp.files[0]) { 
                const r = new FileReader(); 
                r.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = async () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 600;
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        
                        const prefix = currentPose === 'front' ? '' : '_back';
                        const fieldName = field === 'before' ? `photoBefore${prefix}` : `photoAfter${prefix}`;
                        const dateField = field === 'before' ? `dateBefore${prefix}` : `dateAfter${prefix}`;
                        const today = new Date().toLocaleDateString();

                        let update = {}; 
                        update[fieldName] = dataUrl;
                        update[dateField] = today;
                        await updateDoc(doc(db, "users", currentUser.uid), update);
                        userData[fieldName] = dataUrl;
                        userData[dateField] = today;
                        updatePhotoDisplay(userData);
                    };
                }; 
                r.readAsDataURL(inp.files[0]); 
            } 
        };

        window.deletePhoto = async (type) => {
            if(!confirm("¬øBorrar esta foto permanentemente?")) return;
            const prefix = currentPose === 'front' ? '' : '_back';
            const fieldPhoto = type === 'before' ? `photoBefore${prefix}` : `photoAfter${prefix}`;
            const fieldDate = type === 'before' ? `dateBefore${prefix}` : `dateAfter${prefix}`;

            let update = {};
            update[fieldPhoto] = "";
            update[fieldDate] = "";

            await updateDoc(doc(db, "users", currentUser.uid), update);
            userData[fieldPhoto] = "";
            userData[fieldDate] = "";
            updatePhotoDisplay(userData);
        }

        window.moveSlider = (v) => { 
            document.getElementById('img-overlay').style.clipPath = `inset(0 ${100-v}% 0 0)`; 
            document.getElementById('slider-handle').style.left = `${v}%`; 
        };

        async function loadProfile() {
            document.getElementById('profile-name').innerText = userData.name;
            if(userData.photo) { document.getElementById('avatar-text').style.display='none'; document.getElementById('avatar-img').src = userData.photo; document.getElementById('avatar-img').style.display='block'; }
            
            updatePhotoDisplay(userData);

            if(userData.restTime) document.getElementById('cfg-rest-time').value = userData.restTime;
            
            if(userData.stats) {
                document.getElementById('stat-workouts').innerText = userData.stats.workouts || 0;
                document.getElementById('stat-kg').innerText = userData.stats.totalKg ? (userData.stats.totalKg/1000).toFixed(1)+'t' : 0;
                document.getElementById('stat-sets').innerText = userData.stats.totalSets || 0;
                document.getElementById('stat-reps').innerText = userData.stats.totalReps || 0;
            }

            const muscles = ["Pecho","Espalda","Cu√°driceps","Isquios","Gl√∫teos","Hombros","B√≠ceps","Tr√≠ceps"];
            const hC = document.getElementById('heatmap-container'); hC.innerHTML = '';
            const mS = userData.muscleStats || {};
            
            muscles.forEach(m=>{
                const count = mS[m] || 0;
                const pct = Math.min((count / 20) * 100, 100); 
                const d = document.createElement('div'); d.className = 'muscle-bar-group';
                d.innerHTML = `<div class="muscle-label"><span>${m}</span><span>${count} series</span></div><div class="progress-track"><div class="progress-fill" style="width:${pct}%"></div></div>`;
                hC.appendChild(d);
            });
            
            const ctx = document.getElementById('weightChart'); 
            if(chartInstance) chartInstance.destroy();
            const rawData = userData.weightHistory;
            const data = (rawData && rawData.length > 0) ? rawData : [70]; 
            
            chartInstance = new Chart(ctx, { 
                type:'line', 
                data:{ 
                    labels:data.map((_,i)=>`T${i}`), 
                    datasets:[{
                        label:'Kg', 
                        data:data, 
                        borderColor:'#ff3333', 
                        backgroundColor:'rgba(255,51,51,0.1)', 
                        fill:true, 
                        tension:0.4
                    }] 
                }, 
                options:{
                    plugins:{legend:{display:false}},
                    scales:{x:{display:false},y:{grid:{color:'#333'}}},
                    maintainAspectRatio:false
                } 
            });
        }

        window.saveConfig = async () => {
            const rt = document.getElementById('cfg-rest-time').value;
            await updateDoc(doc(db,"users",currentUser.uid), { restTime: parseInt(rt) });
            userData.restTime = parseInt(rt);
            alert("Ajustes Guardados");
        };
        window.savePhotoReminder = async () => {
            const d = document.getElementById('photo-day').value;
            const t = document.getElementById('photo-time').value;
            await updateDoc(doc(db,"users",currentUser.uid), { photoDay:d, photoTime:t });
            userData.photoDay = d; userData.photoTime = t;
            alert("Alarma Guardada");
        };
        window.uploadAvatar = (inp) => { if(inp.files[0]) { const r = new FileReader(); r.onload=async(e)=>{ await updateDoc(doc(db,"users",currentUser.uid), {photo:e.target.result}); loadProfile(); }; r.readAsDataURL(inp.files[0]); } };
        
        window.addWeightEntry = async () => { 
            const wStr = prompt("Introduce tu peso (kg):");
            if(!wStr) return;
            const w = parseFloat(wStr.replace(',','.'));
            if(isNaN(w)) return alert("N√∫mero inv√°lido");

            let history = userData.weightHistory || [];
            history.push(w);

            try {
                await updateDoc(doc(db,"users",currentUser.uid), {weightHistory: history});
                userData.weightHistory = history; 
                loadProfile(); 
                alert("‚úÖ Peso Guardado");
            } catch(e) {
                alert("Error al guardar: " + e.message);
            }
        };

        window.startWorkout = async (rid) => {
            if(document.getElementById('cfg-wake').checked && 'wakeLock' in navigator) try{wakeLock=await navigator.wakeLock.request('screen');}catch(e){}
            const snap = await getDoc(doc(db,"routines",rid));
            const r = snap.data();
            activeWorkout = { name: r.name, exs: r.exercises.map(n => {
                const data = getExerciseData(n);
                // FIXED SETS: 5 SETS TOTAL. 1st is 20 reps, others 16.
                return { n:n, img:data.img, mInfo: data.mInfo, sets:Array(5).fill().map((_,i)=>({r: i===0 ? 20 : 16, w:0, d:false})) }; 
            })};
            
            renderWorkout();
            switchTab('workout-view');
            startTimerMini();
        };

        window.addSet = (exIdx) => {
            activeWorkout.exs[exIdx].sets.push({r:16, w:0, d:false}); 
            renderWorkout();
        };

        window.removeSet = (exIdx) => {
            if(activeWorkout.exs[exIdx].sets.length > 1) {
                activeWorkout.exs[exIdx].sets.pop();
                renderWorkout();
            }
        };

        function renderWorkout() {
            const c = document.getElementById('workout-exercises'); c.innerHTML = '';
            document.getElementById('workout-title').innerText = activeWorkout.name;
            
            activeWorkout.exs.forEach((e,i) => {
                const card = document.createElement('div'); card.className = 'card'; card.style.borderLeft="3px solid var(--accent-color)";
                let bars = `<div class="mini-bar-label"><span>${e.mInfo.main}</span><span>100%</span></div><div class="mini-track"><div class="mini-fill fill-primary"></div></div>`;
                e.mInfo.sec.forEach(s => { bars += `<div class="mini-bar-label" style="margin-top:4px;"><span>${s}</span><span>40%</span></div><div class="mini-track"><div class="mini-fill fill-sec"></div></div>`; });
                let setsHtml = `<div class="set-header"><div>#</div><div>REPS</div><div>KG</div><div></div></div>`;
                
                e.sets.forEach((s,j) => {
                    setsHtml += `<div class="set-row"><div class="set-num">${j+1}</div><div><span class="shadow-val">${s.r}</span><input type="number" value="${s.r}" onchange="uS(${i},${j},'r',this.value)"></div><div><span class="shadow-val">--</span><input type="number" placeholder="kg" value="${s.w}" onchange="uS(${i},${j},'w',this.value)"></div><button id="btn-${i}-${j}" class="btn-outline ${s.d?'btn-done':''}" style="margin:0;padding:0;height:35px;" onclick="tS(${i},${j})">${s.d?'‚úì':''}</button></div>`;
                });

                setsHtml += `<div class="sets-actions"><button class="btn-set-control" onclick="removeSet(${i})">- Serie</button><button class="btn-set-control" onclick="addSet(${i})">+ Serie</button></div>`;

                card.innerHTML = `<div class="workout-split"><div class="workout-visual"><img src="${e.img}" onerror="this.src='logo.png'"></div><div class="workout-bars" style="width:100%">${bars}</div></div><h3 style="margin-bottom:10px; border:none;">${e.n}</h3>${setsHtml}`;
                c.appendChild(card);
            });
        }

        window.uS = (i,j,k,v) => activeWorkout.exs[i].sets[j][k]=v;
        window.tS = (i,j) => {
            const s = activeWorkout.exs[i].sets[j]; s.d = !s.d;
            const btn = document.getElementById(`btn-${i}-${j}`);
            if(s.d) {
                btn.classList.add('btn-done');
                btn.innerText = '‚úì';
                openRest();
            } else {
                btn.classList.remove('btn-done');
                btn.innerText = '';
            }
        };

        function openRest() {
            const m = document.getElementById('modal-timer'); m.classList.add('active');
            const rest = userData.restTime || 60;
            restTimeRemaining = rest;
            document.getElementById('timer-display').innerText = restTimeRemaining;
            
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(() => {
                restTimeRemaining--;
                document.getElementById('timer-display').innerText = restTimeRemaining;
                if(restTimeRemaining <= 0) {
                    clearInterval(timerInt); m.classList.remove('active');
                    if(document.getElementById('cfg-sound').checked) {
                        play5Beeps();
                    }
                }
            }, 1000);
        }
        window.closeTimer = () => { clearInterval(timerInt); document.getElementById('modal-timer').classList.remove('active'); };
        window.addRestTime = (s) => { 
            restTimeRemaining += s; 
            document.getElementById('timer-display').innerText = restTimeRemaining; 
        };
        
        function startTimerMini() { const d=document.getElementById('mini-timer'); const s=Date.now(); setInterval(()=>{const df=Math.floor((Date.now()-s)/1000); d.innerText=`${Math.floor(df/60)}:${(df%60).toString().padStart(2,'0')}`;},1000); }
        
        window.promptRPE = () => {
            document.getElementById('modal-rpe').classList.add('active');
        };

        window.finishWorkout = async (rpeVal) => {
            document.getElementById('modal-rpe').classList.remove('active');
            const note = document.getElementById('workout-notes').value; 
            let s=0, r=0, k=0;
            let muscleCounts = {};
            let prAlert = ""; 

            if(!userData.prs) userData.prs = {};
            
            activeWorkout.exs.forEach(e => {
                e.sets.forEach(st => { 
                    if(st.d) { 
                        s++; 
                        r+=parseInt(st.r)||0; 
                        const weight = parseInt(st.w)||0;
                        k+=weight*(parseInt(st.r)||0); 
                        const mName = e.mInfo.main;
                        muscleCounts[mName] = (muscleCounts[mName] || 0) + 1;

                        if(weight > (userData.prs[e.n] || 0)) {
                            userData.prs[e.n] = weight;
                            prAlert = `üèÜ R√âCORD: ${e.n} (${weight}kg)\n`;
                        }
                    }
                });
            });

            if(prAlert) alert(prAlert); 

            await addDoc(collection(db,"workouts"), {
                uid:currentUser.uid, 
                date:serverTimestamp(), 
                routine:activeWorkout.name,
                rpe: rpeVal,
                note: note
            });
            
            const updates = { 
                "stats.workouts": increment(1), 
                "stats.totalSets": increment(s), 
                "stats.totalReps": increment(r), 
                "stats.totalKg": increment(k),
                "prs": userData.prs 
            };
            
            for (const [muscle, count] of Object.entries(muscleCounts)) {
                updates[`muscleStats.${muscle}`] = increment(count);
            }

            await updateDoc(doc(db,"users",currentUser.uid), updates);
            if(wakeLock) wakeLock.release(); 
            switchTab('routines-view');
        };

        window.loadAdminUsers = async () => {
            const l = document.getElementById('admin-list');
            l.innerHTML = '<div style="text-align:center;padding:20px;color:#888;">‚Üª Cargando base de datos...</div>';
            
            try {
                const s = await getDocs(collection(db, "users"));
                l.innerHTML = '';
                
                if (s.empty) {
                    l.innerHTML = '<div style="text-align:center;padding:20px;">No hay atletas registrados a√∫n.</div>';
                    return;
                }

                s.forEach(d => {
                    const u = d.data(); 
                    if(u.email === ADMIN) return;
                    const div = document.createElement('div');
                    div.className = "admin-user-row";
                    
                    const statusIcon = u.approved ? 'üü¢' : '‚è≥';
                    const statusText = u.approved ? 'Activo' : 'Pendiente';

                    div.innerHTML=`
                        <div>
                            <strong>${u.name}</strong><br>
                            <small>${statusIcon} ${statusText} ‚Ä¢ ${u.email}</small>
                        </div>
                        <button class="btn-outline btn-small" style="width:auto;">‚öôÔ∏è FICHA</button>
                    `;
                    div.onclick=()=>openCoachView(d.id,u); 
                    l.appendChild(div);
                });
            } catch (e) {
                console.error(e);
                l.innerHTML = '<div style="text-align:center;color:red;padding:20px;">Error de conexi√≥n. Intenta de nuevo.</div>';
            }
        };

        async function openCoachView(uid,u) {
            selectedUserCoach=uid;
            
            const freshSnap = await getDoc(doc(db, "users", uid));
            const freshU = freshSnap.data();
            selectedUserObj = freshU; 

            switchTab('coach-detail-view');
            
            document.getElementById('coach-user-name').innerText=freshU.name;
            document.getElementById('coach-user-email').innerText=freshU.email;

            const banner = document.getElementById('pending-approval-banner');
            if(!freshU.approved) {
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
            
            const img = document.getElementById('coach-user-img');
            const initial = document.getElementById('coach-user-initial');
            if(freshU.photo) {
                img.src = freshU.photo; img.style.display = 'block'; initial.style.display = 'none';
            } else {
                img.style.display = 'none'; initial.style.display = 'block';
            }
            
            updateCoachPhotoDisplay('front');

            try {
                const s = document.getElementById('coach-routine-select'); s.innerHTML = '';
                const rS = await getDocs(collection(db,"routines")); 
                allRoutinesCache = [];
                rS.forEach(r => {
                    const data = r.data();
                    allRoutinesCache.push({id: r.id, ...data});
                    const o = document.createElement('option'); 
                    o.value = r.id; 
                    o.innerText = data.name; 
                    s.appendChild(o); 
                });
            } catch(e) { console.error("Error loading routines for dropdown", e); }

            try {
                const st = freshU.stats || {};
                const age = freshU.age ? freshU.age : 'N/D';
                document.getElementById('coach-stats-text').innerHTML = `
                    <div class="stat-pill"><b>${st.workouts||0}</b><span>ENTRENOS</span></div>
                    <div class="stat-pill"><b>${(st.totalKg/1000||0).toFixed(1)}t</b><span>CARGA</span></div>
                    <div class="stat-pill"><b>${age}</b><span>A√ëOS</span></div>
                `;

                if(coachChart) coachChart.destroy();
                const ctx = document.getElementById('coachWeightChart');
                const wData = freshU.weightHistory || [];
                const data = (wData && wData.length > 0) ? wData : [70];
                
                coachChart = new Chart(ctx, { type:'line', data:{ labels:data.map((_,i)=>i+1), datasets:[{label:'Kg', data:data, borderColor:'#ff3333', fill:false}] }, options:{plugins:{legend:{display:false}}, scales:{x:{display:false},y:{grid:{color:'#333'}}}}});

                const rList = document.getElementById('coach-assigned-list');
                rList.innerHTML = 'Cargando...';
                const qR = query(collection(db, "routines"), where("assignedTo", "array-contains", uid));
                const snapR = await getDocs(qR);
                rList.innerHTML = '';
                if(snapR.empty) rList.innerHTML = 'Ninguna rutina asignada.';
                snapR.forEach(r => {
                    const rd = r.data();
                    const div = document.createElement('div');
                    div.className = "assigned-routine-item";
                    div.innerHTML = `<span>${rd.name}</span><button style="background:none;border:none;color:#f55;font-weight:bold;cursor:pointer;" onclick="unassignRoutine('${r.id}')">‚ùå</button>`;
                    rList.appendChild(div);
                });

                const hList = document.getElementById('coach-history-list');
                hList.innerHTML = 'Cargando historial...';
                const qH = query(collection(db,"workouts"), where("uid","==",uid), orderBy("date","desc"), limit(10));
                const wSnap = await getDocs(qH);
                hList.innerHTML = '';
                if(wSnap.empty) hList.innerHTML='Sin datos recientes.';
                wSnap.forEach(w=>{
                    const d = w.data();
                    const date = d.date ? new Date(d.date.seconds*1000).toLocaleDateString() : '-';
                    let rpeBadge = d.rpe === 'Suave' ? '<span class="badge green">üü¢ Suave</span>' : (d.rpe === 'Duro' ? '<span class="badge orange">üü† Duro</span>' : (d.rpe === 'Fallo' ? '<span class="badge red">üî¥ Fallo</span>' : '<span class="badge gray">--</span>'));
                    const noteIcon = (d.note && d.note.trim().length > 0) ? `<span class="note-icon" title="${d.note}" onclick="alert('${d.note}')">üìù</span>` : '';
                    hList.innerHTML += `<div class="history-row"><div class="hist-date">${date}</div><div class="hist-name">${d.routine} ${noteIcon}</div><div class="hist-rpe">${rpeBadge}</div></div>`;
                });
            
            } catch(e) { console.error("Error loading coach details", e); }
        }

        window.approveUser = async () => {
            if(confirm("¬øConfirmar acceso a este atleta?")) {
                await updateDoc(doc(db,"users",selectedUserCoach), {approved: true});
                alert("Atleta Aprobado ‚úÖ");
                openCoachView(selectedUserCoach, selectedUserObj);
            }
        };

        window.renderCoachRoutines = (list) => {
            const s = document.getElementById('coach-routine-select'); s.innerHTML = '';
            list.forEach(r => { const o = document.createElement('option'); o.value = r.id; o.innerText = r.name; s.appendChild(o); });
        };

        window.filterCoachRoutines = (val) => {
            const filtered = allRoutinesCache.filter(r => r.name.toLowerCase().includes(val.toLowerCase()));
            renderCoachRoutines(filtered);
        };

        window.switchCoachPose = (pose) => {
            coachCurrentPose = pose;
            document.getElementById('coach-tab-front').classList.toggle('active', pose==='front');
            document.getElementById('coach-tab-back').classList.toggle('active', pose==='back');
            updateCoachPhotoDisplay(pose);
        };

        function updateCoachPhotoDisplay(pose) {
            const u = selectedUserObj;
            if(!u) return;
            const prefix = pose === 'front' ? '' : '_back';
            const b = u[`photoBefore${prefix}`];
            const a = u[`photoAfter${prefix}`];
            const dateB = u[`dateBefore${prefix}`] || '-';
            const dateA = u[`dateAfter${prefix}`] || '-';
            
            const pCont = document.getElementById('coach-photos-container');
            
            pCont.innerHTML = `
                <div class="compare-wrapper">
                    <img src="${b || ''}" class="compare-img">
                    <img src="${a || ''}" id="coach-overlay-img" class="compare-img img-overlay" style="clip-path:inset(0 100% 0 0)">
                    <div class="slider-handle" id="coach-slider-handle" style="left:0%"><div class="slider-btn"></div></div>
                </div>
                <input type="range" min="0" max="100" value="0" style="width:100%; margin-top:15px;" oninput="moveCoachSlider(this.value)">
                <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#888;">
                    <span>ANTES (${dateB})</span><span>AHORA (${dateA})</span>
                </div>
            `;
        }
        
        window.moveCoachSlider = (v) => {
            document.getElementById('coach-overlay-img').style.clipPath = `inset(0 ${100-v}% 0 0)`;
            document.getElementById('coach-slider-handle').style.left = `${v}%`;
        };

        window.goToCreateRoutine = () => {
            switchTab('routines-view'); 
            openEditor(); 
        };

        window.assignRoutine = async () => {
            const rid=document.getElementById('coach-routine-select').value; if(!rid||!selectedUserCoach)return;
            const rRef=doc(db,"routines",rid); 
            await updateDoc(rRef,{assignedTo: arrayUnion(selectedUserCoach)}); 
            alert("Rutina Asignada");
            openCoachView(selectedUserCoach, selectedUserObj); 
        };

        window.unassignRoutine = async (rid) => {
            if(confirm("¬øQuitar esta rutina al atleta?")) {
                await updateDoc(doc(db, "routines", rid), { assignedTo: arrayRemove(selectedUserCoach) });
                openCoachView(selectedUserCoach, selectedUserObj); 
            }
        };

        window.deleteUser = async () => {
            if(confirm("‚ö† ¬øELIMINAR ATLETA DEFINITIVAMENTE?")) {
                if(confirm("Esta acci√≥n borrar√° todo su historial y acceso. ¬øProceder?")) {
                    try {
                        await deleteDoc(doc(db, "users", selectedUserCoach));
                        alert("Atleta eliminado.");
                        switchTab('admin-view');
                        window.loadAdminUsers();
                    } catch(e) { alert("Error: " + e.message); }
                }
            }
        };

        document.getElementById('btn-login').onclick=()=>signInWithEmailAndPassword(auth,document.getElementById('login-email').value,document.getElementById('login-pass').value).catch(e=>alert(e.message));
        document.getElementById('btn-register').onclick=async()=>{
            if(document.getElementById('reg-code').value!==CODE)return alert("C√≥digo incorrecto");
            try{ const c=await createUserWithEmailAndPassword(auth,document.getElementById('reg-email').value,document.getElementById('reg-pass').value);
            await setDoc(doc(db,"users",c.user.uid),{name:document.getElementById('reg-name').value,email:document.getElementById('reg-email').value,approved:document.getElementById('reg-email').value===ADMIN,age:parseInt(document.getElementById('reg-age').value),height:parseInt(document.getElementById('reg-height').value), weightHistory: []});
            }catch(e){alert(e.message)}
        };
    </script>
</body>
</html>
