<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <title>Fit Data - High Performance</title>
    
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="apple-touch-icon" href="favicon.png">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* PALETA CYBERPUNK */
            --bg: #0a0a0a; 
            --card: #141414; 
            --card-light: #1f1f1f;
            --text: #ffffff; 
            --muted: #888; 
            --accent: #ff4444; 
            --accent-glow: rgba(255, 68, 68, 0.3);
            --success: #22dd88; 
            --warning: #ffaa00;
            --safe-top: env(safe-area-inset-top); 
            --safe-bottom: env(safe-area-inset-bottom);
        }
        
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--text); min-height:100vh; padding-bottom:calc(90px + var(--safe-bottom)); user-select:none; overflow-x: hidden; }
        
        /* UTILIDADES */
        .hidden { display:none !important; }
        .container { max-width:600px; margin:0 auto; padding:20px; padding-top:15px; }
        .text-accent { color:var(--accent); text-shadow: 0 0 10px var(--accent-glow); }
        .text-muted { color:var(--muted); font-size:0.8rem; }
        .flex { display:flex; gap:10px; align-items:center; }
        .flex-between { display:flex; justify-content:space-between; align-items:center; }
        h1, h2, h3 { font-weight:800; letter-spacing:-0.5px; margin-bottom:8px; text-transform: uppercase; }

        /* NAVBARS */
        .navbar-top { position:sticky; top:0; z-index:100; background:rgba(10,10,10,0.95); backdrop-filter:blur(10px); border-bottom:1px solid #333; padding:15px 20px; padding-top:calc(15px + var(--safe-top)); display:flex; justify-content:space-between; align-items:center; }
        .nav-bottom { position:fixed; bottom:0; left:0; width:100%; background:rgba(10,10,10,0.98); border-top:1px solid #333; display:flex; justify-content:space-around; padding:12px 0; padding-bottom:calc(15px + var(--safe-bottom)); z-index:100; }
        .nav-item { color:#666; background:none; border:none; font-size:0.65rem; display:flex; flex-direction:column; align-items:center; width:20%; font-weight:700; text-transform:uppercase; transition:0.3s; }
        .nav-item.active { color:var(--accent); text-shadow:0 0 10px var(--accent-glow); transform:translateY(-2px); }
        .nav-item i { font-size:1.4rem; margin-bottom:4px; font-style:normal; }

        /* ELEMENTOS UI */
        .btn { width:100%; padding:14px; border:none; border-radius:8px; font-weight:700; font-size:0.9rem; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:0.2s; text-transform: uppercase; letter-spacing: 1px; }
        .btn:active { transform:scale(0.97); }
        .btn-primary { background:var(--accent); color:white; box-shadow:0 0 15px var(--accent-glow); }
        .btn-secondary { background:rgba(255,255,255,0.05); border:1px solid #333; color:white; }
        .btn-success { background:var(--success); color:#000; font-weight:800; }
        .btn-icon { background:transparent; border:1px solid #333; color:#aaa; font-size:1.1rem; padding:6px; border-radius:6px; cursor:pointer; min-width:36px; }
        
        .input { width:100%; padding:14px; margin-bottom:10px; background:#111; border:1px solid #333; color:white; border-radius:8px; font-size:1rem; }
        .input:focus { border-color:var(--accent); outline:none; box-shadow:0 0 10px var(--accent-glow); }
        
        .card { background:var(--card); padding:20px; border-radius:12px; margin-bottom:15px; border:1px solid #222; border-left:3px solid var(--accent); position:relative; }
        
        /* GENERATED SVG ICON */
        .ex-img { width:60px; height:60px; background:#fff; border:2px solid var(--accent); border-radius:10px; padding:2px; object-fit:contain; flex-shrink:0; }

        /* WORKOUT ROWS */
        .set-row { display:grid; grid-template-columns:30px 1fr 1fr 40px 40px; gap:8px; align-items:center; background:#181818; padding:8px; border-radius:6px; margin-bottom:6px; border:1px solid #333; position: relative; }
        .set-row.done { border-color:var(--success); background:rgba(34,221,136,0.05); }
        .prev-val { position:absolute; top:-8px; left:50%; transform:translateX(-50%); font-size:0.6rem; color:#666; background:#111; padding:0 4px; border:1px solid #333; border-radius:4px; pointer-events:none; }
        
        .check-btn { width:32px; height:32px; border-radius:50%; border:2px solid #444; background:transparent; display:flex; align-items:center; justify-content:center; cursor:pointer; color:transparent; font-weight:bold; transition:0.2s; }
        .check-btn.checked { background:var(--success); border-color:var(--success); color:black; }
        .check-btn.checked::after { content:'‚úì'; }

        /* STATS & HEATMAP */
        .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px; }
        .stat-box { background:var(--card-light); padding:15px; border-radius:10px; text-align:center; border:1px solid #333; }
        .stat-val { font-size:1.5rem; font-weight:800; color:white; }
        .stat-lbl { font-size:0.65rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }
        .heatmap-container { width:100%; height:300px; display:flex; justify-content:center; }
        
        /* MODALS */
        .screen { display:none; opacity:0; transition:opacity 0.3s; }
        .screen.active { display:block; opacity:1; }
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:5000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(5px); }
        .modal-content { background:var(--card); width:95%; max-width:500px; padding:25px; border-radius:20px; border:1px solid #444; max-height:90vh; overflow-y:auto; }

        /* TOGGLES */
        .toggle-row { display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #222; }
        .switch { position:relative; display:inline-block; width:40px; height:24px; }
        .switch input { opacity:0; width:0; height:0; }
        .slider { position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#333; transition:.4s; border-radius:34px; }
        .slider:before { position:absolute; content:""; height:16px; width:16px; left:4px; bottom:4px; background-color:white; transition:.4s; border-radius:50%; }
        input:checked + .slider { background-color:var(--accent); }
        input:checked + .slider:before { transform:translateX(16px); }

        /* LOADER & TOAST */
        .loading-logo { width:120px; height:120px; margin-bottom:20px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(255,68,68,0)); } 50% { transform: scale(1.05); filter: drop-shadow(0 0 20px rgba(255,68,68,0.5)); } 100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(255,68,68,0)); } }
        
        #toast { visibility:hidden; min-width:250px; background-color:#222; color:#fff; text-align:center; border-radius:50px; padding:12px 20px; position:fixed; z-index:6000; left:50%; bottom:90px; transform:translateX(-50%); border:1px solid var(--accent); box-shadow:0 5px 20px rgba(0,0,0,0.8); }
        #toast.show { visibility:visible; animation:fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from{bottom:60px; opacity:0;} to{bottom:90px; opacity:1;} }
        @keyframes fadeout { from{bottom:90px; opacity:1;} to{bottom:60px; opacity:0;} }

        /* TIMER BUTTON */
        .timer-float { position:fixed; bottom:110px; right:20px; width:70px; height:70px; background:#000; border:3px solid var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.5rem; font-family:monospace; color:var(--accent); box-shadow:0 0 15px var(--accent-glow); z-index:2000; cursor:pointer; }
        
        .user-row { padding:15px; background:var(--card-light); margin-bottom:8px; border-radius:8px; border-left:3px solid #333; display:flex; justify-content:space-between; align-items:center; }
        .stagnant { border-left-color: var(--warning); background: rgba(255, 170, 0, 0.05); }
    </style>
</head>
<body>

    <div id="toast">Notificaci√≥n</div>

    <div id="loading" class="screen active" style="text-align:center; padding-top:35vh; background:#000; z-index:9999;">
        <img src="favicon.png" class="loading-logo" alt="FitData">
        <h1 style="color:var(--accent); font-size:3rem; margin:0;">FIT DATA</h1>
        <p style="color:var(--muted); letter-spacing:2px; font-size:0.9rem;">HIGH PERFORMANCE</p>
    </div>

    <div id="login" class="screen">
        <div class="container" style="text-align:center; padding-top:60px;">
            <img src="favicon.png" style="width:80px; margin-bottom:20px;">
            <h1 class="text-accent">FIT DATA</h1>
            <p class="text-muted" style="margin-bottom:40px;">Acceso Atletas</p>
            <div class="card" style="border:none; background:transparent;">
                <input id="log-email" class="input" type="email" placeholder="Email">
                <input id="log-pass" class="input" type="password" placeholder="Contrase√±a">
                <button onclick="doLogin()" class="btn btn-primary">INICIAR SESI√ìN</button>
                <p onclick="toRegister()" style="margin-top:20px; color:var(--muted); cursor:pointer;">Solicitar Cuenta</p>
            </div>
        </div>
    </div>

    <div id="register" class="screen">
        <div class="container">
            <h2 class="text-center text-accent">Nuevo Perfil</h2>
            <div class="card">
                <input id="reg-name" class="input" placeholder="Nombre Completo">
                <div class="flex">
                    <input id="reg-age" type="number" class="input" placeholder="Edad">
                    <input id="reg-height" type="number" class="input" placeholder="Altura (cm)">
                </div>
                <input id="reg-email" class="input" type="email" placeholder="Email">
                <input id="reg-pass" class="input" type="password" placeholder="Contrase√±a">
                <label class="text-accent" style="font-weight:bold; font-size:0.75rem;">C√ìDIGO DE INVITACI√ìN</label>
                <input id="reg-code" class="input" style="text-align:center; border-color:var(--accent); letter-spacing:4px; font-weight:bold;">
                <button onclick="doRegister()" class="btn btn-primary">CREAR CUENTA</button>
                <button onclick="toLogin()" class="btn btn-secondary">Volver</button>
            </div>
        </div>
    </div>

    <div id="app" class="screen">
        
        <div id="view-home" class="view">
            <div class="navbar-top">
                <div>
                    <h3 id="u-name" style="margin:0;">Atleta</h3>
                    <span id="u-goal" class="text-muted" style="font-size:0.7rem; text-transform:uppercase;">Cargando...</span>
                </div>
                <button id="admin-btn" onclick="nav('view-admin')" class="btn-icon hidden" style="border-color:var(--accent); color:var(--accent);">üëë</button>
            </div>

            <div class="container">
                <div id="stagnation-alert" class="card hidden" style="background:rgba(255,170,0,0.1); border-color:var(--warning); padding:10px; display:flex; align-items:center; gap:10px;">
                    <span style="font-size:1.5rem;">‚ö†Ô∏è</span>
                    <div>
                        <strong style="color:var(--warning)">Alerta Coach</strong><br>
                        <small>Sin registros en +14 d√≠as.</small>
                    </div>
                </div>

                <div class="flex-between" style="margin-bottom:15px;">
                    <h3>Mis Rutinas</h3>
                    <button onclick="openRoutineModal()" class="btn-primary" style="width:auto; padding:8px 15px; font-size:0.8rem;">+ Crear</button>
                </div>

                <div id="routines-list">
                    </div>
            </div>
        </div>

        <div id="view-profile" class="view hidden">
            <div class="navbar-top"><h2>Rendimiento</h2></div>
            <div class="container">
                <div class="card" style="text-align:center; overflow-x:auto;">
                    <h3>Mapa de Calor</h3>
                    <p class="text-muted" style="font-size:0.7rem; margin-bottom:10px;">Basado en volumen total de series</p>
                    <div id="heatmap-render" class="heatmap-container"></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box"><span id="stat-kg" class="stat-val">0</span><span class="stat-lbl">TONELADAS</span></div>
                    <div class="stat-box"><span id="stat-workouts" class="stat-val">0</span><span class="stat-lbl">ENTRENOS</span></div>
                    <div class="stat-box"><span id="stat-sets" class="stat-val">0</span><span class="stat-lbl">SERIES</span></div>
                    <div class="stat-box"><span id="stat-reps" class="stat-val">0</span><span class="stat-lbl">REPS</span></div>
                </div>

                <div class="card">
                    <h3>Peso Corporal</h3>
                    <canvas id="weightChart" style="max-height:200px; margin-bottom:15px;"></canvas>
                    <div class="flex">
                        <input id="new-weight" type="number" class="input" placeholder="Kg actuales" style="margin:0;">
                        <button onclick="saveWeight()" class="btn btn-primary" style="width:auto; margin:0;">Guardar</button>
                    </div>
                </div>

                <div class="card">
                    <div class="flex-between">
                        <h3>Check F√≠sico</h3>
                        <label class="btn btn-secondary" style="width:auto; padding:6px 12px; font-size:0.8rem;">
                            üì∑ Subir <input type="file" id="photo-in" accept="image/*" hidden onchange="uploadPhoto(this)">
                        </label>
                    </div>
                    <div id="gallery" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px;"></div>
                </div>
            </div>
        </div>

        <div id="view-config" class="view hidden">
            <div class="navbar-top"><h2>Ajustes</h2></div>
            <div class="container">
                <div class="card">
                    <h3>Estado F√≠sico (Solo lectura)</h3>
                    <p class="text-muted">Etapa asignada por el coach:</p>
                    <div id="cfg-goal-display" class="input" style="text-align:center; color:var(--accent); font-weight:bold;">-</div>

                    <h3 style="margin-top:20px;">Preferencias</h3>
                    <div class="toggle-row">
                        <span>Recordatorio Fotos</span>
                        <div class="flex">
                            <select id="cfg-alarm-day" class="input" style="width:auto; margin:0;" onchange="saveConfig()">
                                <option value="-1">Off</option>
                                <option value="1">Lun</option>
                                <option value="5">Vie</option>
                                <option value="0">Dom</option>
                            </select>
                            <input type="time" id="cfg-alarm-time" class="input" style="width:auto; margin:0;" onchange="saveConfig()">
                        </div>
                    </div>

                    <div style="margin-top:15px;">
                        <label class="text-muted">Descanso entre series (seg)</label>
                        <input id="cfg-rest" type="number" class="input" value="60" onchange="saveConfig()">
                    </div>
                    
                    <div class="toggle-row">
                        <span>Sonido Alarma</span>
                        <label class="switch"><input type="checkbox" id="cfg-sound" onchange="saveConfig()"><span class="slider"></span></label>
                    </div>
                    <div class="toggle-row">
                        <span>Pantalla Encendida</span>
                        <label class="switch"><input type="checkbox" id="cfg-screen" onchange="saveConfig()"><span class="slider"></span></label>
                    </div>
                </div>
                <button onclick="auth.signOut()" class="btn btn-secondary">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div id="view-admin" class="view hidden">
            <div class="navbar-top">
                <h2>Panel Coach</h2>
                <button onclick="nav('view-home')" class="btn btn-secondary" style="width:auto; padding:5px 10px;">Volver</button>
            </div>
            <div class="container">
                <div class="card">
                    <h3>Solicitudes (<span id="count-pending">0</span>)</h3>
                    <div id="adm-pending"></div>
                </div>
                <h3>Cartera de Atletas</h3>
                <div id="adm-users"></div>
            </div>
        </div>

        <div class="nav-bottom">
            <button class="nav-item active" onclick="nav('view-home')"><i>üèãÔ∏è</i>Rutinas</button>
            <button class="nav-item" onclick="nav('view-profile')"><i>üìä</i>Perfil</button>
            <button class="nav-item" onclick="nav('view-config')"><i>‚öôÔ∏è</i>Ajustes</button>
        </div>
    </div>

    <div id="workout-ui" class="screen" style="z-index:2000; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); overflow-y:auto;">
        <div class="navbar-top">
            <button onclick="exitWorkout()" class="btn-icon">‚Üê</button>
            <div id="wo-title" style="font-weight:bold; color:var(--accent);">Rutina</div>
            <div id="wo-timer" style="font-family:monospace; border:1px solid var(--accent); padding:2px 8px; border-radius:6px;">00:00</div>
        </div>
        <div id="wo-container" class="container"></div>
        <div style="height:100px;"></div>
        <div style="position:fixed; bottom:0; left:0; width:100%; background:rgba(10,10,10,0.95); padding:15px; border-top:1px solid #333; padding-bottom:calc(15px + var(--safe-bottom)); text-align:center;">
            <button onclick="finishPrompt()" class="btn btn-success" style="margin:0;">FINALIZAR ENTRENAMIENTO</button>
        </div>
        <div id="float-timer" class="timer-float hidden">
            <span id="timer-val" onclick="stopRest()">60</span>
            <div onclick="addTime(event)" style="font-size:0.6rem; position:absolute; bottom:-15px; background:#333; padding:2px 5px; border-radius:4px; color:white;">+20s</div>
        </div>
    </div>

    <div id="modal-athlete" class="modal hidden">
        <div class="modal-content">
            <div class="flex-between">
                <h2 id="adm-ath-name">Atleta</h2>
                <button onclick="closeAdminModal()" class="btn-icon">X</button>
            </div>
            
            <div class="card">
                <h3>Configuraci√≥n Coach</h3>
                <label class="text-muted">Etapa Actual:</label>
                <select id="adm-set-goal" class="input">
                    <option value="Definici√≥n">Definici√≥n</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Volumen">Volumen</option>
                </select>
                <button onclick="adminSaveConfig()" class="btn btn-primary" style="margin-top:5px;">Guardar Config</button>
            </div>

            <div class="card">
                <h3>Estad√≠sticas</h3>
                <div class="flex-between" style="margin-bottom:10px;">
                    <small>Edad: <span id="adm-ath-age">-</span></small>
                    <small>Altura: <span id="adm-ath-height">-</span></small>
                </div>
                <div class="stats-grid">
                    <div class="stat-box"><span id="adm-ath-kg" class="stat-val">0</span><small>KG</small></div>
                    <div class="stat-box"><span id="adm-ath-sets" class="stat-val">0</span><small>SERIES</small></div>
                </div>
            </div>

            <div class="card">
                <h3>Peso</h3>
                <canvas id="adminWeightChart" style="max-height:150px;"></canvas>
            </div>

            <h3>Fotos</h3>
            <div id="admin-gallery" style="display:grid; grid-template-columns:1fr 1fr; gap:5px;"></div>
        </div>
    </div>

    <div id="modal-create" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-routine-title">Nueva Rutina</h3>
            <p id="routine-target-msg" class="text-muted hidden" style="color:var(--success);">Asignando a: <span id="target-user-name"></span></p>
            
            <input id="new-rout-name" class="input" placeholder="Nombre (Ej: Pierna A)">
            <input id="search-ex" class="input" placeholder="üîç Buscar ejercicio..." onkeyup="renderExSelector()">
            <div id="ex-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid #333; border-radius:8px; padding:5px;"></div>
            <div class="flex">
                <button onclick="saveRoutine()" class="btn btn-primary">GUARDAR</button>
                <button onclick="document.getElementById('modal-create').classList.add('hidden')" class="btn btn-secondary">CANCELAR</button>
            </div>
        </div>
    </div>

    <div id="modal-rpe" class="modal hidden">
        <div class="modal-content" style="text-align:center;">
            <h3>¬øQu√© tal fue? (RPE)</h3>
            <div style="display:grid; gap:10px; margin-top:20px;">
                <button onclick="saveWorkoutLog(1)" class="btn" style="background:#22dd88; color:black;">RPE 1-4 (F√°cil)</button>
                <button onclick="saveWorkoutLog(2)" class="btn" style="background:#ffaa00; color:black;">RPE 5-7 (Medio)</button>
                <button onclick="saveWorkoutLog(3)" class="btn" style="background:#ff4444; color:white;">RPE 8-10 (Fallo)</button>
            </div>
        </div>
    </div>

    <audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

    <script>
        // --- 1. CONFIGURACI√ìN FIREBASE (PEGA TUS CLAVES AQU√ç) ---
        // ******************************************************
        // Import the functions you need from the SDKs you need
// --- 1. CONFIGURACI√ìN FIREBASE CORREGIDA ---
        const firebaseConfig = {
            apiKey: "AIzaSyCmM0gViU3itZ4HIZZVTEm7OaV0iBtsiGs",
            authDomain: "fitdata-7a86b.firebaseapp.com",
            projectId: "fitdata-7a86b",
            storageBucket: "fitdata-7a86b.firebasestorage.app",
            messagingSenderId: "949628013924",
            appId: "1:949628013924:web:86278ae2c2bafb384d7e71"

        // Inicializaci√≥n (Sintaxis Compat)
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase inicializado correctamente");
        } catch(e) {
            console.error("Error al iniciar Firebase:", e);
            alert("Error de conexi√≥n: Revisa la consola (F12)");
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        };
        // ******************************************************
        
        // Inicializaci√≥n segura (evita error si no hay config)
        try {
            firebase.initializeApp(firebaseConfig);
        } catch(e) {
            console.error("Falta configuraci√≥n Firebase");
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 2. CONSTANTES ---
        const ADMIN_EMAIL = "toni@fitdatapro.es";
        const SECRET_CODE = "fityhab";
        
        // Estado Global
        let currentUser = null;
        let userData = null;
        let selectedExs = [];
        let activeRoutine = null;
        let woStartTime = null;
        let woTimerInt = null;
        let restTimerInt = null;
        let wakeLock = null;
        let weightChart = null;
        let adminWeightChart = null;
        let currentAdminUser = null;
        let adminAssignTarget = null;
        let editingRoutineId = null;

        // --- 3. GENERADOR SVG ANAT√ìMICO (VECTORIAL PURO) ---
        function getMuscleSvg(muscle) {
            const m = muscle.toLowerCase();
            
            // Definici√≥n de Paths Anat√≥micos
            const paths = {
                bodyFront: "M50,5 C55,5 60,10 60,15 L65,18 L70,35 L60,60 L62,80 L65,115 L55,115 L52,85 L48,85 L45,115 L35,115 L38,80 L40,60 L30,35 L35,18 L40,15 C40,10 45,5 50,5",
                bodyBack: "M50,5 C55,5 60,10 60,15 L68,18 L75,35 L65,60 L62,80 L65,115 L55,115 L52,85 L48,85 L45,115 L35,115 L38,80 L35,60 L25,35 L32,18 L40,15 C40,10 45,5 50,5",
                chest: "M38,22 L62,22 L60,35 L40,35 Z",
                abs: "M42,38 L58,38 L56,58 L44,58 Z",
                shouldersF: "M30,22 L35,22 L32,28 Z M70,22 L65,22 L68,28 Z", // Simplificado c√≠rculos
                biceps: "M28,35 L22,55 L32,55 Z M72,35 L78,55 L68,55 Z",
                quads: "M38,60 L35,115 L45,115 L48,85 L52,85 L55,115 L65,115 L62,60 Z",
                lats: "M35,20 L65,20 L58,50 L42,50 Z",
                triceps: "M25,30 L20,50 L30,50 Z M75,30 L80,50 L70,50 Z",
                glute: "M35,60 L65,60 L60,75 L40,75 Z",
                hams: "M35,75 L32,110 L45,110 L48,85 L52,85 L55,110 L68,110 L65,75 Z",
                calves: "M32,110 L28,140 L40,140 Z M68,110 L72,140 L60,140 Z" // Approx
            };

            let view = `<path d="${paths.bodyFront}" fill="#000"/>`; 
            let highlight = "";

            if (m.includes('pecho')) highlight = `<path d="${paths.chest}" fill="#ff4444"/>`;
            else if (m.includes('abs')) highlight = `<path d="${paths.abs}" fill="#ff4444"/>`;
            else if (m.includes('hombro')) highlight = `<circle cx="30" cy="22" r="6" fill="#ff4444"/><circle cx="70" cy="22" r="6" fill="#ff4444"/>`;
            else if (m.includes('biceps') || m.includes('b√≠ceps')) highlight = `<path d="${paths.biceps}" fill="#ff4444"/>`;
            else if (m.includes('cu√°driceps') || m.includes('cuadriceps')) highlight = `<path d="${paths.quads}" fill="#ff4444"/>`;
            else if (m.includes('espalda') || m.includes('dorsal')) { view = `<path d="${paths.bodyBack}" fill="#000"/>`; highlight = `<path d="${paths.lats}" fill="#ff4444"/>`; }
            else if (m.includes('triceps') || m.includes('tr√≠ceps')) { view = `<path d="${paths.bodyBack}" fill="#000"/>`; highlight = `<path d="${paths.triceps}" fill="#ff4444"/>`; }
            else if (m.includes('gl√∫teo') || m.includes('gluteos')) { view = `<path d="${paths.bodyBack}" fill="#000"/>`; highlight = `<path d="${paths.glute}" fill="#ff4444"/>`; }
            else if (m.includes('isquiotibiales') || m.includes('femoral')) { view = `<path d="${paths.bodyBack}" fill="#000"/>`; highlight = `<path d="${paths.hams}" fill="#ff4444"/>`; }
            else if (m.includes('gemelo')) { view = `<path d="${paths.bodyBack}" fill="#000"/>`; highlight = `<path d="M35,115 L30,135 L40,135 Z M65,115 L70,135 L60,135 Z" fill="#ff4444"/>`; }
            else if (m.includes('piernas')) { view = `<path d="${paths.bodyBack}" fill="#000"/>`; highlight = `<path d="${paths.hams}" fill="#ff4444"/>`; } // Default piernas

            return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 150">
              <rect x="2" y="2" width="96" height="146" rx="10" fill="#ffffff" stroke="#ff4444" stroke-width="4"/>
              ${view}
              ${highlight}
            </svg>`);
        }

        function renderHeatmap(stats) {
            const container = document.getElementById('heatmap-render');
            if (!container) return;
            const getOp = (key) => Math.min(0.2 + ((stats[key]||0) / 40), 1);
            
            container.innerHTML = `
            <svg viewBox="0 0 220 150" style="height:100%; display:block; margin:0 auto; filter:drop-shadow(0 0 5px rgba(255,68,68,0.3));">
                <g transform="translate(10,10)">
                    <path d="M50,5 C55,5 60,10 60,15 L65,18 L70,35 L60,60 L62,80 L65,115 L55,115 L52,85 L48,85 L45,115 L35,115 L38,80 L40,60 L30,35 L35,18 L40,15 C40,10 45,5 50,5" fill="#222" />
                    <path d="M38,22 L62,22 L60,35 L40,35 Z" fill="#ff4444" fill-opacity="${getOp('Pecho')}"/>
                    <path d="M42,38 L58,38 L56,58 L44,58 Z" fill="#ff4444" fill-opacity="${getOp('Abs')}"/>
                    <circle cx="30" cy="22" r="6" fill="#ff4444" fill-opacity="${getOp('Hombros')}"/>
                    <circle cx="70" cy="22" r="6" fill="#ff4444" fill-opacity="${getOp('Hombros')}"/>
                    <path d="M28,35 L22,55 L32,55 Z" fill="#ff4444" fill-opacity="${getOp('B√≠ceps')}"/>
                    <path d="M72,35 L78,55 L68,55 Z" fill="#ff4444" fill-opacity="${getOp('B√≠ceps')}"/>
                    <path d="M38,60 L35,115 L45,115 L48,85 L52,85 L55,115 L65,115 L62,60 Z" fill="#ff4444" fill-opacity="${getOp('Cu√°driceps')}"/>
                </g>
                <g transform="translate(110,10)">
                    <path d="M50,5 C55,5 60,10 60,15 L68,18 L75,35 L65,60 L62,80 L65,115 L55,115 L52,85 L48,85 L45,115 L35,115 L38,80 L35,60 L25,35 L32,18 L40,15 C40,10 45,5 50,5" fill="#222" />
                    <path d="M35,20 L65,20 L58,50 L42,50 Z" fill="#ff4444" fill-opacity="${getOp('Espalda')}"/>
                    <path d="M25,30 L20,50 L30,50 Z" fill="#ff4444" fill-opacity="${getOp('Tr√≠ceps')}"/>
                    <path d="M75,30 L80,50 L70,50 Z" fill="#ff4444" fill-opacity="${getOp('Tr√≠ceps')}"/>
                    <path d="M35,60 L65,60 L60,75 L40,75 Z" fill="#ff4444" fill-opacity="${getOp('Gl√∫teos')}"/>
                    <path d="M35,75 L32,110 L45,110 L48,85 L52,85 L55,110 L68,110 L65,75 Z" fill="#ff4444" fill-opacity="${getOp('Isquiotibiales')}"/>
                    <path d="M35,115 L30,135 L40,135 Z" fill="#ff4444" fill-opacity="${getOp('Gemelo')}"/>
                    <path d="M65,115 L70,135 L60,135 Z" fill="#ff4444" fill-opacity="${getOp('Gemelo')}"/>
                </g>
            </svg>`;
        }

        // 4. BASE DE DATOS (82 Ejercicios)
        const rawExercisesDB = [
            // Piernas
            {id:1, name:'Sentadilla con Barra', muscle:'Cu√°driceps'},
            {id:2, name:'Sentadilla Jaca', muscle:'Cu√°driceps'},
            {id:3, name:'Sentadilla con Cintur√≥n', muscle:'Cu√°driceps'},
            {id:4, name:'Prensa de Piernas', muscle:'Cu√°driceps'},
            {id:5, name:'Extensi√≥n de Cu√°driceps', muscle:'Cu√°driceps'},
            {id:6, name:'Estocadas con Mancuernas', muscle:'Cu√°driceps'},
            {id:7, name:'Curl de Pierna Tumbado', muscle:'Isquiotibiales'},
            {id:8, name:'Curl de Pierna Sentado', muscle:'Isquiotibiales'},
            {id:9, name:'Prensa Horizontal', muscle:'Cu√°driceps'},
            {id:10, name:'Prensa 45¬∞', muscle:'Cu√°driceps'},
            {id:11, name:'Elevaci√≥n Talones Sentado', muscle:'Gemelo'},
            {id:12, name:'Elevaci√≥n Talones Pie', muscle:'Gemelo'},
            {id:13, name:'Elevaci√≥n Talones M√°quina', muscle:'Gemelo'},
            {id:14, name:'Hip Thrust', muscle:'Gl√∫teos'},
            {id:15, name:'Sentadilla B√∫lgara', muscle:'Cu√°driceps'},
            {id:16, name:'Patada Gl√∫teo Polea', muscle:'Gl√∫teos'},
            {id:17, name:'Abducci√≥n Cadera', muscle:'Gl√∫teos'},
            {id:18, name:'Prensa Gl√∫teos', muscle:'Gl√∫teos'},
            {id:19, name:'Peso Muerto Rumano', muscle:'Isquiotibiales'},
            // Espalda
            {id:20, name:'Peso Muerto', muscle:'Espalda'},
            {id:21, name:'Peso Muerto Sumo', muscle:'Espalda'},
            {id:22, name:'Remo con Barra', muscle:'Espalda'},
            {id:23, name:'Remo con Mancuernas', muscle:'Espalda'},
            {id:24, name:'Jal√≥n Lateral', muscle:'Espalda'},
            {id:25, name:'Jal√≥n Cerrado', muscle:'Espalda'},
            {id:26, name:'Remo en M√°quina', muscle:'Espalda'},
            {id:27, name:'Remo Polea Baja', muscle:'Espalda'},
            {id:28, name:'Dominadas', muscle:'Espalda'},
            {id:29, name:'Dominadas Asistidas', muscle:'Espalda'},
            {id:30, name:'Remo Invertido', muscle:'Espalda'},
            {id:31, name:'Remo T', muscle:'Espalda'},
            {id:32, name:'Hiperextensi√≥n', muscle:'Espalda'},
            {id:33, name:'Buenos D√≠as', muscle:'Isquiotibiales'},
            {id:34, name:'Remo Hammer', muscle:'Espalda'},
            {id:35, name:'Remo Alto', muscle:'Espalda'},
            // Pecho
            {id:36, name:'Press Banca', muscle:'Pecho'},
            {id:37, name:'Press Inclinado Mancuernas', muscle:'Pecho'},
            {id:38, name:'Aperturas Mancuernas', muscle:'Pecho'},
            {id:39, name:'Cruces Polea', muscle:'Pecho'},
            {id:40, name:'Press M√°quina', muscle:'Pecho'},
            {id:41, name:'Press Declinado', muscle:'Pecho'},
            {id:42, name:'Fondos Paralelas', muscle:'Pecho'},
            {id:43, name:'Aperturas M√°quina', muscle:'Pecho'},
            {id:44, name:'Press Inclinado Barra', muscle:'Pecho'},
            {id:45, name:'Press Plano M√°quina', muscle:'Pecho'},
            {id:46, name:'Prensa Lateral Iso', muscle:'Pecho'},
            {id:47, name:'Chest Press', muscle:'Pecho'},
            // Hombros
            {id:48, name:'Encogimientos Barra', muscle:'Espalda'},
            {id:49, name:'Encogimientos Mancuernas', muscle:'Espalda'},
            {id:50, name:'Press Militar', muscle:'Hombros'},
            {id:51, name:'Press Hombros Mancuernas', muscle:'Hombros'},
            {id:52, name:'Press Hombros M√°quina', muscle:'Hombros'},
            {id:53, name:'Elevaci√≥n Lateral', muscle:'Hombros'},
            {id:54, name:'Elevaci√≥n Frontal', muscle:'Hombros'},
            {id:55, name:'P√°jaros', muscle:'Hombros'},
            {id:56, name:'Elevaci√≥n Lateral Polea', muscle:'Hombros'},
            {id:57, name:'Press Arnold', muscle:'Hombros'},
            {id:58, name:'Face Pull', muscle:'Hombros'},
            // Brazos
            {id:59, name:'Curl Barra', muscle:'B√≠ceps'},
            {id:60, name:'Curl Mancuernas', muscle:'B√≠ceps'},
            {id:61, name:'Curl Polea', muscle:'B√≠ceps'},
            {id:62, name:'Curl Martillo', muscle:'B√≠ceps'},
            {id:63, name:'Curl Concentrado', muscle:'B√≠ceps'},
            {id:64, name:'Curl Predicador', muscle:'B√≠ceps'},
            {id:65, name:'Extensi√≥n Polea', muscle:'Tr√≠ceps'},
            {id:66, name:'Press Franc√©s', muscle:'Tr√≠ceps'},
            {id:67, name:'Rompecr√°neos', muscle:'Tr√≠ceps'},
            {id:68, name:'Fondos Tr√≠ceps', muscle:'Tr√≠ceps'},
            {id:69, name:'Extensi√≥n Unilateral', muscle:'Tr√≠ceps'},
            {id:70, name:'Tr√≠ceps Barra', muscle:'Tr√≠ceps'},
            // Abs
            {id:71, name:'Rueda Abdominal', muscle:'Abs'},
            {id:72, name:'Crunch Polea', muscle:'Abs'},
            {id:73, name:'Elevaci√≥n Piernas', muscle:'Abs'},
            {id:74, name:'Abdominales Banco', muscle:'Abs'},
            {id:75, name:'Crunch M√°quina', muscle:'Abs'},
            {id:76, name:'Rodillas al Pecho', muscle:'Abs'},
            // Extras
            {id:77, name:'Cardio LISS', muscle:'Piernas'},
            {id:78, name:'Cardio HIIT', muscle:'Piernas'},
            {id:79, name:'El√≠ptica', muscle:'Piernas'},
            {id:80, name:'Cinta Correr', muscle:'Piernas'},
            {id:81, name:'Escaleras', muscle:'Piernas'},
            {id:82, name:'Remo Concept', muscle:'Espalda'}
        ];

        const exercisesDB = rawExercisesDB.map(ex => ({ ...ex, image: getMuscleSvg(ex.muscle) }));

        function showToast(msg) { const t=document.getElementById("toast"); t.innerText=msg; t.className="show"; setTimeout(()=>t.className="",3000); }

        // 5. AUTH & LOGIC
        auth.onAuthStateChanged(async u => {
            if(u) {
                db.collection('users').doc(u.uid).onSnapshot(doc => {
                    if(doc.exists) {
                        userData = doc.data();
                        
                        checkAlarms();

                        if(userData.email.toLowerCase() === ADMIN_EMAIL) listenToAllUsers();
                        
                        if(userData.approved || userData.email.toLowerCase() === ADMIN_EMAIL) {
                            currentUser = u;
                            setTimeout(() => {
                                document.getElementById('loading').classList.remove('active');
                                initApp();
                                loadWorkoutFromStorage(); 
                            }, 2000);
                        } else {
                            document.getElementById('loading').classList.remove('active');
                            showToast("Pendiente de Aprobaci√≥n"); showScreen('login');
                        }
                    }
                });
            } else { 
                document.getElementById('loading').classList.remove('active');
                showScreen('login'); 
            }
        });

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function toRegister() { showScreen('register'); }
        function toLogin() { showScreen('login'); }
        
        async function doLogin() { try { await auth.signInWithEmailAndPassword(document.getElementById('log-email').value, document.getElementById('log-pass').value); } catch(e) { showToast(e.message); } }
        
        async function doRegister() {
            if(document.getElementById('reg-code').value !== SECRET_CODE) return showToast("C√≥digo incorrecto");
            try {
                const email = document.getElementById('reg-email').value;
                const isAdmin = email.toLowerCase() === ADMIN_EMAIL;
                const cred = await auth.createUserWithEmailAndPassword(email, document.getElementById('reg-pass').value);
                await db.collection('users').doc(cred.user.uid).set({
                    username: document.getElementById('reg-name').value, 
                    email, 
                    age: document.getElementById('reg-age').value,
                    height: document.getElementById('reg-height').value,
                    role: isAdmin?'admin':'user', approved: isAdmin, 
                    settings:{rest:60, screen:true, sound:true, goal:'Mantenimiento', alarmDay: -1},
                    stats:{kg:0, workouts:0, sets:0, reps:0, heatmap:{}},
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast(isAdmin?"Hola Coach":"Solicitud Enviada");
            } catch(e) { showToast(e.message); }
        }

        // 6. APP INIT & ALARMS
        function checkAlarms() {
            if(!userData.settings.alarmDay || userData.settings.alarmDay == -1) return;
            const now = new Date();
            const today = now.getDay();
            const todayStr = now.toDateString();
            const lastCheck = localStorage.getItem('last_photo_alarm');
            
            const alarmTime = userData.settings.alarmTime; 
            if(alarmTime) {
                const [h, m] = alarmTime.split(':');
                const nowMins = now.getHours()*60 + now.getMinutes();
                const alarmMins = parseInt(h)*60 + parseInt(m);
                if(today == userData.settings.alarmDay && nowMins >= alarmMins && lastCheck !== todayStr) {
                    alert("üì∏ RECORDATORIO: ¬°Subir foto de revisi√≥n!");
                    localStorage.setItem('last_photo_alarm', todayStr);
                }
            }
        }

        async function initApp() {
            showScreen('app'); nav('view-home');
            document.getElementById('u-name').innerText = userData.username.split(' ')[0];
            document.getElementById('u-goal').innerText = userData.settings.goal || 'Mantenimiento';
            
            if(userData.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
            
            document.getElementById('cfg-goal-display').innerText = userData.settings.goal || 'Mantenimiento';
            document.getElementById('cfg-rest').value = userData.settings.rest || 60;
            document.getElementById('cfg-screen').checked = userData.settings.screen;
            document.getElementById('cfg-sound').checked = userData.settings.sound;
            document.getElementById('cfg-alarm-day').value = userData.settings.alarmDay || -1;
            if(userData.settings.alarmTime) document.getElementById('cfg-alarm-time').value = userData.settings.alarmTime;

            loadRoutines(); loadProfile();
        }

        function nav(vid) {
            document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
            document.getElementById(vid).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            if(vid.includes('home')) document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            if(vid.includes('profile')) document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            if(vid.includes('config')) document.querySelector('.nav-item:nth-child(3)').classList.add('active');
        }

        // 7. DASHBOARD & ROUTINES
        async function loadRoutines() {
            const l = document.getElementById('routines-list'); 
            db.collection('users').doc(currentUser.uid).collection('routines').orderBy('createdAt','desc').onSnapshot(s => {
                l.innerHTML = '';
                if(s.empty) l.innerHTML = '<p class="text-center text-muted" style="margin-top:20px;">Sin rutinas asignadas.</p>';
                s.forEach(d => {
                    const r = d.data();
                    const icons = r.exercises.slice(0,5).map(e=>`<img src="${e.image}" style="width:25px; height:25px; object-fit:contain; background:#fff; border-radius:4px;">`).join(' ');
                    const div = document.createElement('div'); div.className='card';
                    div.innerHTML = `
                        <div class="flex-between"><h3>${r.name}</h3></div>
                        <div style="margin:10px 0;">${icons}</div>
                        <button onclick="startWo('${d.id}')" class="btn btn-primary">ENTRENAR</button>`;
                    l.appendChild(div);
                });
            });
        }

        // 8. ENTRENAMIENTO
        function saveWorkoutToStorage() {
            if (activeRoutine) localStorage.setItem('fitdata_wo', JSON.stringify({routine: activeRoutine, start: woStartTime}));
        }
        function loadWorkoutFromStorage() {
            const saved = localStorage.getItem('fitdata_wo');
            if(saved) {
                const data = JSON.parse(saved);
                if(new Date() - new Date(data.start) < 3*60*60*1000) {
                    if(confirm("¬øRecuperar entreno anterior?")) {
                        activeRoutine = data.routine;
                        woStartTime = new Date(data.start);
                        renderWorkoutScreen();
                    } else localStorage.removeItem('fitdata_wo');
                } else localStorage.removeItem('fitdata_wo');
            }
        }

        async function startWo(id) {
            const doc = await db.collection('users').doc(currentUser.uid).collection('routines').doc(id).get();
            const r = doc.data(); 
            const preparedExercises = r.exercises.map(ex => ({
                ...ex,
                series: Array(5).fill().map((_, i) => ({ weight: '', reps: i===0?20:16, completed: false }))
            }));

            activeRoutine = {id, name: r.name, exercises: preparedExercises};
            woStartTime = new Date();
            
            if(userData.settings.screen && 'wakeLock' in navigator) try{ wakeLock=await navigator.wakeLock.request('screen'); }catch(e){}
            saveWorkoutToStorage();
            renderWorkoutScreen();
        }

        async function renderWorkoutScreen() {
            document.getElementById('workout-ui').classList.add('active');
            document.getElementById('wo-title').innerText = activeRoutine.name;
            const c = document.getElementById('wo-container'); c.innerHTML='';

            let lastWorkout = null;
            try {
                const hSnap = await db.collection('users').doc(currentUser.uid).collection('history')
                    .where('routineId','==',activeRoutine.id).orderBy('date','desc').limit(1).get();
                if(!hSnap.empty) lastWorkout = hSnap.docs[0].data();
            } catch(e) {}

            activeRoutine.exercises.forEach((ex, idx) => {
                let rows = '';
                ex.series.forEach((s, i) => {
                    const prev = lastWorkout?.exercises?.[idx]?.series?.[i]?.weight || '-';
                    const rowClass = s.completed ? 'set-row done' : 'set-row';
                    const checkClass = s.completed ? 'check-btn checked' : 'check-btn';
                    
                    rows += `
                    <div class="${rowClass}" id="row-${idx}-${i}">
                        <div style="text-align:center; color:#666; font-size:0.8rem;">${i+1}</div>
                        <input type="number" class="input" value="${s.reps}" onchange="updateSet(${idx},${i},'reps',this.value)" style="margin:0; text-align:center; padding:8px;">
                        <div style="position:relative;">
                            <span class="prev-val">${prev}kg</span>
                            <input type="number" class="input" value="${s.weight}" onchange="updateSet(${idx},${i},'weight',this.value)" placeholder="kg" style="margin:0; text-align:center; padding:8px;">
                        </div>
                        <div class="${checkClass}" onclick="checkSet(this, ${idx}, ${i})"></div>
                    </div>`;
                });
                
                c.innerHTML += `
                <div class="card">
                    <div class="flex-between" style="margin-bottom:10px;">
                        <div class="flex">
                            <img src="${ex.image}" class="ex-img">
                            <h4>${ex.name}</h4>
                        </div>
                    </div>
                    ${rows}
                </div>`;
            });

            if(woTimerInt) clearInterval(woTimerInt);
            woTimerInt = setInterval(()=>{
                const d = Math.floor((new Date()-woStartTime)/1000);
                document.getElementById('wo-timer').innerText = `${Math.floor(d/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`;
            },1000);
        }

        function updateSet(exIdx, sIdx, field, val) {
            activeRoutine.exercises[exIdx].series[sIdx][field] = val;
            saveWorkoutToStorage();
        }

        function checkSet(btn, exIdx, sIdx) {
            if(btn.classList.contains('checked')) return;
            btn.classList.add('checked'); 
            document.getElementById(`row-${exIdx}-${sIdx}`).classList.add('done');
            activeRoutine.exercises[exIdx].series[sIdx].completed = true;
            saveWorkoutToStorage();

            const s = activeRoutine.exercises[exIdx].series[sIdx];
            if(s.weight > 0) {
                const onerm = s.weight * (1 + s.reps/30);
                if(s.weight > 80) showToast(`üèÜ R√©cord! 1RM: ${Math.round(onerm)}kg`); 
            }
            startRest();
        }

        function startRest() {
            const t = document.getElementById('float-timer'); 
            const val = document.getElementById('timer-val');
            t.classList.remove('hidden');
            let sec = userData.settings.rest || 60; val.innerText = sec;
            
            if(restTimerInt) clearInterval(restTimerInt);
            restTimerInt = setInterval(()=>{
                sec--; val.innerText=sec;
                if(sec<=0) { 
                    clearInterval(restTimerInt); t.classList.add('hidden'); 
                    if(userData.settings.sound) document.getElementById('beep').play().catch(e=>{}); 
                    if(navigator.vibrate) navigator.vibrate(500); 
                }
            },1000);
        }
        function addTime(e) { e.stopPropagation(); let v = document.getElementById('timer-val'); v.innerText = parseInt(v.innerText)+20; }
        function stopRest() { clearInterval(restTimerInt); document.getElementById('float-timer').classList.add('hidden'); }
        function finishPrompt() { document.getElementById('modal-rpe').classList.remove('hidden'); }
        
        async function saveWorkoutLog(rpe) {
            document.getElementById('modal-rpe').classList.add('hidden');
            let totalKg=0, totalSets=0, totalReps=0;
            let muscleMap = userData.stats?.heatmap || {};

            activeRoutine.exercises.forEach(ex => {
                ex.series.forEach(s => {
                    if(s.completed) {
                        totalKg += (parseFloat(s.weight)||0) * (parseFloat(s.reps)||0);
                        totalSets++;
                        totalReps += parseFloat(s.reps)||0;
                        muscleMap[ex.muscle] = (muscleMap[ex.muscle] || 0) + 1;
                    }
                });
            });

            const newStats = {
                kg: (userData.stats?.kg||0) + totalKg,
                sets: (userData.stats?.sets||0) + totalSets,
                reps: (userData.stats?.reps||0) + totalReps,
                workouts: (userData.stats?.workouts||0) + 1,
                heatmap: muscleMap
            };

            await db.collection('users').doc(currentUser.uid).update({ stats: newStats });
            await db.collection('users').doc(currentUser.uid).collection('history').add({
                date: firebase.firestore.FieldValue.serverTimestamp(),
                routineId: activeRoutine.id, routineName: activeRoutine.name,
                duration: Math.floor((new Date()-woStartTime)/1000), rpe, 
                exercises: activeRoutine.exercises
            });

            if(wakeLock) wakeLock.release();
            localStorage.removeItem('fitdata_wo');
            exitWorkout(); showToast("Entreno Guardado üöÄ");
        }
        function exitWorkout() { document.getElementById('workout-ui').classList.remove('active'); stopRest(); initApp(); }

        // 9. PROFILE & STATS
        function loadProfile() {
            const s = userData.stats || {kg:0, workouts:0, sets:0, reps:0, heatmap:{}};
            document.getElementById('stat-kg').innerText = (s.kg/1000).toFixed(1) + 't';
            document.getElementById('stat-workouts').innerText = s.workouts;
            document.getElementById('stat-sets').innerText = s.sets;
            document.getElementById('stat-reps').innerText = s.reps;
            renderHeatmap(s.heatmap || {});
            loadGraph(); loadPhotos();
        }

        async function saveConfig() {
            // Solo usuario guarda alertas y sistema, etapa es solo lectura aqui
            const screen = document.getElementById('cfg-screen').checked;
            const sound = document.getElementById('cfg-sound').checked;
            const rest = parseInt(document.getElementById('cfg-rest').value);
            const alarmDay = parseInt(document.getElementById('cfg-alarm-day').value);
            const alarmTime = document.getElementById('cfg-alarm-time').value;
            
            await db.collection('users').doc(currentUser.uid).update({
                'settings.screen': screen, 'settings.sound': sound, 'settings.rest': rest, 
                'settings.alarmDay': alarmDay, 'settings.alarmTime': alarmTime
            });
            userData.settings = { ...userData.settings, screen, sound, rest, alarmDay, alarmTime };
            showToast("Perfil Actualizado");
        }

        async function loadGraph() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const s = await db.collection('users').doc(currentUser.uid).collection('weights').orderBy('date','asc').limit(10).get();
            const d = s.docs.map(x => ({x: x.data().date.toDate().toLocaleDateString(), y: x.data().val}));
            if(weightChart) weightChart.destroy();
            weightChart = new Chart(ctx, { type:'line', data:{labels:d.map(i=>i.x), datasets:[{label:'Peso', data:d.map(i=>i.y), borderColor:'#ff4444', backgroundColor:'rgba(255,68,68,0.1)', fill:true}]}, options:{scales:{y:{beginAtZero:false}}, plugins:{legend:{display:false}}} });
        }
        async function saveWeight() {
            const val = parseFloat(document.getElementById('new-weight').value);
            if(!val) return;
            await db.collection('users').doc(currentUser.uid).collection('weights').add({val, date:firebase.firestore.FieldValue.serverTimestamp()});
            loadGraph(); showToast("Peso registrado");
        }
        
        async function uploadPhoto(inp) {
            const f = inp.files[0];
            if(!f) return;
            const img = new Image(); img.src = URL.createObjectURL(f);
            img.onload = async () => {
                const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                const sc = 600/img.width; cvs.width=600; cvs.height=img.height*sc;
                ctx.drawImage(img,0,0,cvs.width,cvs.height);
                const b64 = cvs.toDataURL('image/jpeg', 0.6);
                await db.collection('users').doc(currentUser.uid).collection('photos').add({img:b64, date:firebase.firestore.FieldValue.serverTimestamp()});
                showToast("Foto subida"); loadPhotos();
            }
        }
        async function loadPhotos() {
            const g = document.getElementById('gallery'); g.innerHTML='';
            const s = await db.collection('users').doc(currentUser.uid).collection('photos').orderBy('date','desc').get();
            const p = s.docs.map(d=>d.data());
            if(p.length) {
                document.getElementById('comp-before').innerHTML = `<img src="${p[p.length-1].img}" style="width:100%; height:100%; object-fit:cover;">`;
                document.getElementById('comp-now').innerHTML = `<img src="${p[0].img}" style="width:100%; height:100%; object-fit:cover;">`;
            }
            p.forEach(x => {
                const d = document.createElement('div'); d.className='card'; d.style.padding='5px';
                d.innerHTML = `<img src="${x.img}" style="width:100%; border-radius:4px;"><div class="text-muted text-center" style="font-size:0.7rem;">${x.date?x.date.toDate().toLocaleDateString():''}</div>`;
                g.appendChild(d);
            });
        }

        // --- 10. ADMIN REAL-TIME ---
        function listenToAllUsers() {
            db.collection('users').orderBy('createdAt','desc').onSnapshot(snap => {
                const pend = document.getElementById('adm-pending'); const usrs = document.getElementById('adm-users');
                const count = document.getElementById('count-pending');
                pend.innerHTML=''; usrs.innerHTML='';
                let pCount=0;
                
                snap.forEach(d => {
                    const u = d.data();
                    const item = `
                    <div class="user-row">
                        <div><b>${u.username}</b><br><small class="text-muted">${u.email}</small></div>
                        <div>
                            ${u.approved ? 
                            `<button onclick="assignRout('${d.id}', '${u.username}')" class="btn-icon">üìã</button>
                             <button onclick="viewUserAdmin('${d.id}')" class="btn-icon">üëÅÔ∏è</button>` : 
                            `<button onclick="approve('${d.id}')" class="btn-success" style="padding:4px 8px; width:auto; font-size:0.8rem;">OK</button>`}
                            <button onclick="delUser('${d.id}')" class="btn-icon">üóëÔ∏è</button>
                        </div>
                    </div>`;
                    
                    if(!u.approved && u.role!=='admin') { pend.innerHTML+=item; pCount++; }
                    else if(u.role!=='admin') usrs.innerHTML+=item;
                });
                
                if(pend.innerHTML==='') pend.innerHTML = '<p class="text-muted text-center">Sin solicitudes.</p>';
                if(count) count.innerText = pCount;
            });
        }

        async function viewUserAdmin(uid) {
            currentAdminUser = uid;
            document.getElementById('modal-athlete').classList.remove('hidden');

            const uDoc = await db.collection('users').doc(uid).get();
            const u = uDoc.data();
            
            document.getElementById('adm-ath-name').innerText = u.username;
            document.getElementById('adm-set-goal').value = u.settings?.goal || 'Mantenimiento';
            
            document.getElementById('adm-ath-age').innerText = u.age || '-';
            document.getElementById('adm-ath-height').innerText = u.height || '-';
            document.getElementById('adm-ath-kg').innerText = (u.stats?.kg/1000).toFixed(1) + 't';
            document.getElementById('adm-ath-sets').innerText = u.stats?.sets || 0;

            const ctx = document.getElementById('adminWeightChart').getContext('2d');
            const wSnap = await db.collection('users').doc(uid).collection('weights').orderBy('date','asc').limit(10).get();
            const data = wSnap.docs.map(x => ({x: x.data().date.toDate().toLocaleDateString(), y: x.data().val}));
            
            if(adminWeightChart) adminWeightChart.destroy();
            adminWeightChart = new Chart(ctx, { type:'line', data:{labels:data.map(i=>i.x), datasets:[{label:'Peso', data:data.map(i=>i.y), borderColor:'#ff4444'}]} });

            const pSnap = await db.collection('users').doc(uid).collection('photos').orderBy('date','desc').limit(4).get();
            const gallery = document.getElementById('admin-gallery'); gallery.innerHTML='';
            pSnap.forEach(d => { gallery.innerHTML += `<img src="${d.data().img}" style="width:100%; border-radius:4px; border:1px solid #333;">`; });
        }

        function closeAdminModal() { document.getElementById('modal-athlete').classList.add('hidden'); }

        async function adminSaveConfig() {
            const goal = document.getElementById('adm-set-goal').value;
            await db.collection('users').doc(currentAdminUser).update({ 'settings.goal': goal });
            showToast("Etapa actualizada");
        }

        async function approve(id) { await db.collection('users').doc(id).update({approved:true}); }
        async function delUser(id) { if(confirm("Borrar?")) await db.collection('users').doc(id).delete(); }
        
        function assignRout(uid, uname) {
            adminAssignTarget = uid;
            document.getElementById('modal-routine-title').innerText = "Nueva Rutina";
            document.getElementById('routine-target-msg').classList.remove('hidden');
            document.getElementById('target-user-name').innerText = uname;
            
            selectedExs = [];
            document.getElementById('new-rout-name').value = '';
            renderExSelector();
            document.getElementById('modal-create').classList.remove('hidden');
        }

        // --- UTILS ---
        function openRoutineModal() { 
            editingRoutineId = null; 
            adminAssignTarget = null;
            document.getElementById('modal-routine-title').innerText = "Nueva Rutina";
            document.getElementById('routine-target-msg').classList.add('hidden');
            
            selectedExs=[]; 
            document.getElementById('new-rout-name').value=''; 
            renderExSelector(); 
            document.getElementById('modal-create').classList.remove('hidden'); 
        }

        function renderExSelector() {
            const f = document.getElementById('search-ex').value.toLowerCase();
            const c = document.getElementById('ex-list'); c.innerHTML='';
            exercisesDB.filter(e=>e.name.toLowerCase().includes(f)).forEach(e => {
                const d = document.createElement('div');
                d.className = 'flex'; d.style.padding='8px'; d.style.borderBottom='1px solid #333'; d.style.cursor='pointer';
                if(selectedExs.includes(e.id)) d.style.background='rgba(255,68,68,0.2)';
                
                d.innerHTML = `<img src="${e.image}" style="width:30px; height:30px; object-fit:contain; background:#fff; border-radius:4px;"><div><b>${e.name}</b><br><small class="text-muted">${e.muscle}</small></div>`;
                d.onclick = ()=>{ 
                    if(selectedExs.includes(e.id)) selectedExs=selectedExs.filter(x=>x!==e.id); 
                    else selectedExs.push(e.id); 
                    renderExSelector(); 
                };
                c.appendChild(d);
            });
        }

        async function saveRoutine() {
            const name = document.getElementById('new-rout-name').value;
            if(!name || selectedExs.length === 0) return showToast("Faltan datos");
            
            const exs = selectedExs.map(id => exercisesDB.find(e => e.id === id)).filter(e => e !== undefined);
            
            if(adminAssignTarget) {
                await db.collection('users').doc(adminAssignTarget).collection('routines').add({
                    name, exercises: exs, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Rutina asignada");
            } else {
                await db.collection('users').doc(currentUser.uid).collection('routines').add({
                    name, exercises: exs, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast("Rutina creada");
            }
            
            document.getElementById('modal-create').classList.add('hidden');
            editingRoutineId = null;
            adminAssignTarget = null;
        }
    </script>
</body>

</html>
