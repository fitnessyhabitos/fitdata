<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
    <title>Fit Data by Toni</title>
    
    <link rel="apple-touch-icon" href="favicon.png">
    <link rel="icon" type="image/png" href="favicon.png">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            /* CORPORATIVO FIT DATA */
            --bg: #0a0a0a; 
            --card: #1a1a1a; 
            --text: #ffffff; 
            --muted: #b0b0b0;
            --accent: #ff4444;       /* Rojo Vivo */
            --accent-dim: rgba(255, 68, 68, 0.2);
            --success: #22dd88; 
            --warning: #ffaa00;
        }
        
        * { margin:0; padding:0; box-sizing:border-box; font-family:-apple-system, sans-serif; -webkit-tap-highlight-color:transparent; outline:none; }
        body { background:var(--bg); color:var(--text); min-height:100vh; padding-bottom:80px; overscroll-behavior-y:none; }
        
        /* UI Kit */
        .hidden { display:none !important; }
        .container { max-width:600px; margin:0 auto; padding:20px; }
        
        /* Typography */
        h1, h2, h3 { font-weight:800; letter-spacing:-0.5px; }
        .text-accent { color:var(--accent); }
        .text-muted { color:var(--muted); font-size:0.9rem; }
        
        /* Buttons & Inputs */
        .btn { width:100%; padding:14px; border:none; border-radius:8px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:10px; font-size:1rem; transition:0.2s; }
        .btn:active { transform:scale(0.98); }
        .btn-primary { background:var(--accent); color:white; }
        .btn-secondary { background:transparent; border:1px solid var(--accent); color:var(--accent); }
        .btn-success { background:var(--success); color:black; }
        
        .input { width:100%; padding:12px; margin-bottom:10px; background:#222; border:1px solid #444; color:white; border-radius:6px; font-size:1rem; }
        .input:focus { border-color:var(--accent); }
        
        /* Cards */
        .card { background:var(--card); padding:20px; border-radius:12px; margin-bottom:15px; border-left:4px solid var(--accent); box-shadow:0 4px 15px rgba(0,0,0,0.4); position:relative; }
        
        /* Nav Bottom */
        .nav-bottom { position:fixed; bottom:0; left:0; width:100%; background:var(--card); border-top:1px solid #333; display:flex; justify-content:space-around; padding:12px; z-index:100; backdrop-filter:blur(10px); }
        .nav-item { color:#666; background:none; border:none; font-size:0.7rem; display:flex; flex-direction:column; align-items:center; }
        .nav-item.active { color:var(--accent); }
        .nav-item i { font-size:1.4rem; margin-bottom:4px; }

        /* --- NUEVO GENERADOR DE IM√ÅGENES (ESTILO PREMIUM) --- */
        .ex-img { 
            width:60px; height:60px; 
            background:white; 
            border:2px solid var(--accent); 
            border-radius:10px; 
            padding:2px; 
            object-fit:contain; 
            flex-shrink:0;
        }

        /* Workout UI */
        .set-row { display:grid; grid-template-columns:30px 1fr 1fr 40px 40px; gap:8px; align-items:center; background:#252525; padding:10px; border-radius:6px; margin-bottom:6px; position:relative; }
        .set-row.done { border:1px solid var(--success); background:rgba(34,221,136,0.1); }
        .prev-weight { position:absolute; top:-8px; left:50%; transform:translateX(-50%); font-size:0.65rem; color:#888; background:#252525; padding:0 4px; border-radius:4px; }
        .check-btn { width:32px; height:32px; border-radius:50%; border:2px solid #666; background:none; display:flex; align-items:center; justify-content:center; cursor:pointer; color:transparent; font-weight:bold; }
        .check-btn.checked { background:var(--success); border-color:var(--success); color:black; }
        .check-btn.checked::after { content:'‚úì'; }

        /* Timer Float */
        .timer-float { position:fixed; bottom:90px; right:20px; width:70px; height:70px; background:#222; border:2px solid var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:1.4rem; font-family:monospace; color:var(--accent); box-shadow:0 4px 20px rgba(0,0,0,0.8); z-index:1000; cursor:pointer; animation: pulse 1s infinite; }
        @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4);} 70% {box-shadow: 0 0 0 10px rgba(255, 68, 68, 0);} 100% {box-shadow: 0 0 0 0 rgba(255, 68, 68, 0);} }

        /* Progress & Admin */
        .photo-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px; }
        .photo-item { aspect-ratio:3/4; background:#333; border-radius:8px; overflow:hidden; position:relative; }
        .photo-item img { width:100%; height:100%; object-fit:cover; }
        .user-row { display:flex; justify-content:space-between; align-items:center; padding:15px; background:#222; border-radius:8px; margin-bottom:8px; border-left:3px solid #444; }
        
        /* Toast Notification */
        #toast { visibility:hidden; min-width:250px; background-color:#333; color:#fff; text-align:center; border-radius:8px; padding:16px; position:fixed; z-index:3000; left:50%; bottom:30px; transform:translateX(-50%); border:1px solid var(--accent); }
        #toast.show { visibility:visible; animation:fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from{bottom:0; opacity:0;} to{bottom:30px; opacity:1;} }
        @keyframes fadeout { from{bottom:30px; opacity:1;} to{bottom:0; opacity:0;} }

        /* Modals & Screens */
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; display:flex; align-items:center; justify-content:center; }
        .modal-content { background:var(--card); width:90%; max-width:500px; padding:25px; border-radius:16px; border:1px solid var(--accent); max-height:90vh; overflow-y:auto; }
        .screen { display:none; opacity:0; transition:opacity 0.3s; }
        .screen.active { display:block; opacity:1; }
        
        /* Note Button */
        .note-btn { background:none; border:none; color:#666; font-size:1.2rem; cursor:pointer; }
        .note-active { color:var(--warning); }
    </style>
</head>
<body>

    <div id="toast">Notificaci√≥n</div>

    <div id="loading" class="screen active" style="text-align:center; padding-top:40vh;">
        <h1 style="color:var(--accent); font-size:3rem;">FIT DATA</h1><p class="text-muted">Iniciando sistema...</p>
    </div>

    <div id="login" class="screen">
        <div class="container" style="padding-top:60px; text-align:center;">
            <h1 style="color:var(--accent); font-size:3rem; margin-bottom:10px;">FIT DATA</h1>
            <p class="text-muted" style="margin-bottom:40px;">Entrenamiento de Alto Rendimiento</p>
            <div class="card">
                <input id="log-email" class="input" type="email" placeholder="Email">
                <input id="log-pass" class="input" type="password" placeholder="Contrase√±a">
                <button onclick="doLogin()" class="btn btn-primary">ENTRAR</button>
                <p onclick="toRegister()" style="margin-top:20px; color:#888; cursor:pointer; text-decoration:underline;">Solicitar Cuenta</p>
            </div>
        </div>
    </div>

    <div id="register" class="screen">
        <div class="container" style="padding-top:40px;">
            <div class="card">
                <h3 class="text-center text-accent" style="margin-bottom:20px;">Nuevo Atleta</h3>
                <input id="reg-name" class="input" placeholder="Nombre Completo">
                <input id="reg-email" class="input" type="email" placeholder="Email">
                <input id="reg-pass" class="input" type="password" placeholder="Contrase√±a">
                <label class="text-accent" style="font-weight:bold; font-size:0.8rem;">C√ìDIGO SECRETO</label>
                <input id="reg-code" class="input" style="text-align:center; border-color:var(--accent); letter-spacing:3px;">
                <button onclick="doRegister()" class="btn btn-primary">SOLICITAR ACCESO</button>
                <button onclick="toLogin()" class="btn btn-secondary">Volver</button>
            </div>
        </div>
    </div>

    <div id="app" class="screen">
        <div id="view-home" class="view">
            <div class="container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
                    <h2 id="u-name">Hola</h2>
                    <button id="admin-btn" onclick="nav('view-admin')" class="btn btn-secondary hidden" style="width:auto; padding:5px 15px; font-size:0.8rem;">COACH</button>
                </div>
                
                <div id="stagnation-alert" class="card hidden" style="background:rgba(255,170,0,0.1); border-color:var(--warning);">
                    ‚ö†Ô∏è <strong style="color:var(--warning)">Alerta:</strong> Sin registros en 14 d√≠as.
                </div>

                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button onclick="openRoutineModal()" class="btn btn-primary" style="margin:0;">+ Nueva Rutina</button>
                </div>

                <h3 class="text-accent" style="border-bottom:1px solid #333; margin-bottom:15px; padding-bottom:5px;">Mis Rutinas</h3>
                <div id="routines-list"></div>
            </div>
        </div>

        <div id="view-progress" class="view hidden">
            <div class="container">
                <h2 class="text-accent" style="margin-bottom:20px;">Evoluci√≥n</h2>
                
                <div class="card">
                    <h3>Peso Corporal</h3>
                    <canvas id="weightChart" style="max-height:200px; margin-bottom:15px;"></canvas>
                    <div style="display:flex; gap:10px;">
                        <input id="new-weight" type="number" class="input" placeholder="kg" style="margin:0;">
                        <button onclick="saveWeight()" class="btn btn-primary" style="width:auto; margin:0;">Guardar</button>
                    </div>
                </div>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Fotos</h3>
                        <label class="btn btn-secondary" style="width:auto; font-size:0.8rem; padding:5px 10px;">
                            + Subir <input type="file" id="photo-in" accept="image/*" hidden onchange="uploadPhoto(this)">
                        </label>
                    </div>
                    <p class="text-muted" style="margin-bottom:15px;">Misma luz, ropa y lugar.</p>
                    
                    <div class="compare-box" style="display:flex; gap:5px; margin-bottom:15px;">
                        <div id="comp-before" style="flex:1; aspect-ratio:3/4; border:1px dashed #444; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden;"><small>Inicio</small></div>
                        <div id="comp-now" style="flex:1; aspect-ratio:3/4; border:1px dashed #444; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden;"><small>Actual</small></div>
                    </div>
                    <div id="gallery" class="photo-grid"></div>
                </div>
            </div>
        </div>

        <div id="view-admin" class="view hidden">
            <div class="container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2 class="text-accent">Panel Coach</h2>
                    <button onclick="nav('view-home')" class="btn btn-secondary" style="width:auto; padding:5px 10px;">Volver</button>
                </div>
                
                <div class="card">
                    <h3>Solicitudes Pendientes</h3>
                    <div id="adm-pending"></div>
                </div>
                <h3>Cartera de Atletas</h3>
                <div id="adm-users"></div>
            </div>
        </div>

        <div id="view-config" class="view hidden">
            <div class="container">
                <h2 class="text-accent" style="margin-bottom:20px;">Ajustes</h2>
                <div class="card">
                    <label>Tiempo de Descanso (segundos)</label>
                    <input id="cfg-rest" type="number" class="input" value="60">
                    <button onclick="saveConfig()" class="btn btn-primary">Guardar Cambios</button>
                </div>
                <button onclick="auth.signOut()" class="btn btn-secondary">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="nav-bottom">
            <button class="nav-item active" onclick="nav('view-home')"><span>üèãÔ∏è</span>Rutinas</button>
            <button class="nav-item" onclick="nav('view-progress')"><span>üìà</span>Progreso</button>
            <button class="nav-item" onclick="nav('view-config')"><span>‚öôÔ∏è</span>Perfil</button>
        </div>
    </div>

    <div id="workout-ui" class="screen" style="z-index:1500; position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); overflow-y:auto;">
        <div style="position:sticky; top:0; background:var(--card); padding:15px; border-bottom:1px solid var(--accent); display:flex; justify-content:space-between; align-items:center; z-index:100;">
            <button onclick="exitWorkout()" style="width:auto; background:none; border:none; color:white; font-size:1.5rem;">‚Üê</button>
            <div id="wo-title" style="font-weight:bold; color:var(--accent);">Rutina</div>
            <div id="wo-timer" style="font-family:monospace; border:1px solid var(--accent); padding:2px 8px; border-radius:6px; color:var(--accent);">00:00</div>
        </div>
        <div id="wo-container" class="container" style="padding-bottom:120px;"></div>
        <div class="container" style="position:fixed; bottom:0; left:0; width:100%; background:var(--bg); padding:15px; border-top:1px solid #333;">
            <button onclick="finishPrompt()" class="btn btn-success" style="margin:0;">FINALIZAR ENTRENAMIENTO</button>
        </div>
        <div id="float-timer" class="timer-float hidden" onclick="stopRest()">60</div>
    </div>

    <div id="modal-create" class="modal hidden">
        <div class="modal-content">
            <h3>Nueva Rutina</h3>
            <input id="new-rout-name" class="input" placeholder="Nombre (Ej: Pierna Hipertrofia)">
            <input id="search-ex" class="input" placeholder="üîç Buscar ejercicio..." onkeyup="renderExSelector()">
            <div id="ex-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid #333; border-radius:8px; padding:5px;"></div>
            <div style="display:flex; gap:10px;">
                <button onclick="saveRoutine()" class="btn btn-primary">Guardar</button>
                <button onclick="document.getElementById('modal-create').classList.add('hidden')" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="modal-rpe" class="modal hidden">
        <div class="modal-content text-center">
            <h3>Dificultad (RPE)</h3>
            <p class="text-muted" style="margin-bottom:20px;">¬øQu√© tal ha ido el entreno?</p>
            <button onclick="saveWorkoutLog(1)" class="btn" style="background:#22dd88; color:black;">F√°cil (1-4)</button>
            <button onclick="saveWorkoutLog(2)" class="btn" style="background:#ffaa00; color:black;">Moderado (5-7)</button>
            <button onclick="saveWorkoutLog(3)" class="btn" style="background:#ff4444; color:white;">Extremo/Fallo (8-10)</button>
        </div>
    </div>

    <div id="modal-note" class="modal hidden">
        <div class="modal-content">
            <h3>Nota del Ejercicio</h3>
            <textarea id="note-text" class="input" rows="4" placeholder="Ej: Sill√≠n al 6, molestias en hombro..."></textarea>
            <div style="display:flex; gap:10px;">
                <button onclick="saveNote()" class="btn btn-primary">Guardar Nota</button>
                <button onclick="document.getElementById('modal-note').classList.add('hidden')" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>

    <audio id="beep" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

    <script>
        // 1. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCmM0gViU3itZ4HIZZVTEm7OaV0iBtsiGs",
            authDomain: "fitdata-7a86b.firebaseapp.com",
            projectId: "fitdata-7a86b",
            storageBucket: "fitdata-7a86b.firebasestorage.app",
            messagingSenderId: "949628013924",
            appId: "1:949628013924:web:86278ae2c2bafb384d7e71"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. CONSTANTES
        const ADMIN_EMAIL = "toni@fitdata.com";
        const SECRET_CODE = "fityhab";
        
        let currentUser = null;
        let userData = null;
        let selectedExs = [];
        let activeRoutine = null;
        let woStartTime = null;
        let woTimerInt = null;
        let restTimerInt = null;
        let wakeLock = null;
        let currentNoteExId = null;
        let weightChart = null;

        // 3. GENERADOR DE IM√ÅGENES "PREMIUM" (SVG DIBUJADO A MANO)
        function getMuscleSvg(muscle) {
            const m = muscle.toLowerCase();
            let p = ''; // Path del m√∫sculo rojo
            let s = ''; // Silueta espec√≠fica

            // Definici√≥n de Siluetas y M√∫sculos
            if(m.includes('pierna') || m.includes('femoral') || m.includes('gemelo') || m.includes('glute')) {
                // Silueta: Tren inferior
                s = 'M35,40 L35,85 L42,85 L42,60 L45,60 L45,85 L55,85 L55,60 L58,60 L58,85 L65,85 L65,40 Q50,30 35,40';
                p = 'M35,40 L35,85 L42,85 L42,60 L45,60 L45,85 L55,85 L55,60 L58,60 L58,85 L65,85 L65,40 Q50,30 35,40'; // Todo rojo
            } else if(m.includes('biceps') || m.includes('b√≠ceps')) {
                // Silueta: Doble b√≠ceps (brazos arriba)
                s = 'M30,30 L20,20 L25,15 L35,25 L40,25 L40,50 L60,50 L60,25 L65,25 L75,15 L80,20 L70,30 L65,30 L65,40 L35,40 L35,30 Z';
                p = 'M20,20 L25,15 L35,25 L35,30 L30,30 Z M80,20 L75,15 L65,25 L65,30 L70,30 Z'; // Solo brazos rojos
            } else if(m.includes('espalda')) {
                // Silueta: Torso en V (Espalda)
                s = 'M30,30 L40,50 L40,70 L60,70 L60,50 L70,30 Q50,20 30,30';
                p = 'M30,30 L40,50 L40,70 L60,70 L60,50 L70,30 Q50,20 30,30'; // Todo rojo
            } else {
                // Silueta Gen√©rica Torso
                s = 'M35,30 L35,70 L65,70 L65,30 Q50,20 35,30';
                if(m.includes('pecho')) p = 'M35,30 L35,45 L65,45 L65,30 Q50,20 35,30';
                else if(m.includes('abs')) p = 'M40,45 L40,65 L60,65 L60,45 Z';
                else if(m.includes('hombro')) p = 'M30,30 L40,30 L40,40 L30,35 Z M70,30 L60,30 L60,40 L70,35 Z';
            }

            return "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <rect x="5" y="5" width="90" height="90" rx="15" fill="#ffffff" stroke="#ff4444" stroke-width="5"/>
                <path d="${s || 'M35,30 L35,70 L65,70 L65,30 Q50,20 35,30'}" fill="#000000"/>
                ${p ? `<path d="${p}" fill="#ff4444" stroke="none"/>` : ''}
            </svg>`);
        }

        // 4. BASE DE DATOS (82 Ejercicios)
        const rawList = [
            "Sentadilla con Barra|Piernas", "Sentadilla Jaca|Piernas", "Sentadilla Cintur√≥n|Piernas", "Prensa de Piernas|Piernas", "Extensi√≥n Cu√°driceps|Piernas", "Estocadas|Piernas", "Curl Femoral Tumbado|Piernas", "Curl Femoral Sentado|Piernas", "Prensa Horizontal|Piernas", "Prensa 45|Piernas", "Gemelo Sentado|Piernas", "Gemelo de Pie|Piernas", "Hip Thrust|Piernas", "Sentadilla B√∫lgara|Piernas", "Patada Gl√∫teo|Piernas", "Abductores|Piernas",
            "Peso Muerto|Espalda", "Peso Muerto Rumano|Piernas", "Peso Muerto Sumo|Espalda", "Remo Barra|Espalda", "Remo Mancuernas|Espalda", "Jal√≥n al Pecho|Espalda", "Jal√≥n Cerrado|Espalda", "Remo M√°quina|Espalda", "Remo Polea Baja|Espalda", "Dominadas|Espalda", "Dominadas Asistidas|Espalda", "Remo Invertido|Espalda", "Remo T|Espalda", "Hiperextensi√≥n|Espalda", "Buenos D√≠as|Espalda",
            "Press Banca|Pecho", "Press Inclinado Mancuernas|Pecho", "Aperturas|Pecho", "Cruces Polea|Pecho", "Press M√°quina|Pecho", "Press Declinado|Pecho", "Fondos|Pecho", "Press Inclinado Barra|Pecho", "Press Plano Mancuernas|Pecho",
            "Encogimientos|Hombros", "Press Militar|Hombros", "Press Militar Mancuernas|Hombros", "Press M√°quina Hombros|Hombros", "Elevaciones Laterales|Hombros", "Elevaciones Frontales|Hombros", "P√°jaros|Hombros", "Elevaci√≥n Polea|Hombros", "Press Arnold|Hombros", "Face Pull|Hombros", "Remo al Ment√≥n|Hombros",
            "Curl Barra|B√≠ceps", "Curl Mancuernas|B√≠ceps", "Curl Polea|B√≠ceps", "Curl Martillo|B√≠ceps", "Curl Concentrado|B√≠ceps", "Curl Predicador|B√≠ceps",
            "Extensi√≥n Polea|Tr√≠ceps", "Press Franc√©s|Tr√≠ceps", "Rompecr√°neos|Tr√≠ceps", "Fondos Tr√≠ceps|Tr√≠ceps", "Extensi√≥n Unilateral|Tr√≠ceps", "Tr√≠ceps Barra|Tr√≠ceps",
            "Rueda Abdominal|Abs", "Crunch Polea|Abs", "Elevaci√≥n Piernas|Abs", "Crunch Banco|Abs", "Crunch M√°quina|Abs", "Plancha|Abs"
        ];
        const exercisesDB = rawList.map((s,i) => { const [n,m]=s.split('|'); return {id:i+1, name:n, muscle:m, image:getMuscleSvg(m)}; });

        // 5. TOAST SYSTEM
        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg; t.className = "show";
            setTimeout(function(){ t.className = t.className.replace("show", ""); }, 3000);
        }

        // 6. AUTH & LOGIC
        auth.onAuthStateChanged(async u => {
            if(u) {
                const doc = await db.collection('users').doc(u.uid).get();
                if(doc.exists) {
                    userData = doc.data();
                    if(userData.approved || userData.email === ADMIN_EMAIL) {
                        currentUser = u;
                        initApp();
                    } else { auth.signOut(); showToast("Pendiente de aprobaci√≥n"); showScreen('login'); }
                } else { auth.signOut(); showScreen('login'); }
            } else { showScreen('login'); }
            document.getElementById('loading').classList.remove('active');
        });

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function toRegister() { showScreen('register'); }
        function toLogin() { showScreen('login'); }
        
        async function doLogin() {
            try { await auth.signInWithEmailAndPassword(document.getElementById('log-email').value, document.getElementById('log-pass').value); }
            catch(e) { showToast(e.message); }
        }

        async function doRegister() {
            if(document.getElementById('reg-code').value !== SECRET_CODE) return showToast("C√≥digo incorrecto");
            try {
                const email = document.getElementById('reg-email').value;
                const cred = await auth.createUserWithEmailAndPassword(email, document.getElementById('reg-pass').value);
                const isAdmin = email.toLowerCase() === ADMIN_EMAIL.toLowerCase();
                await db.collection('users').doc(cred.user.uid).set({
                    username: document.getElementById('reg-name').value, email, 
                    role: isAdmin?'admin':'user', approved: isAdmin, settings:{rest:60},
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showToast(isAdmin ? "Bienvenido Jefe" : "Solicitud enviada");
                if(!isAdmin) showScreen('login');
            } catch(e) { showToast(e.message); }
        }

        // 7. APP INIT
        async function initApp() {
            showScreen('app'); nav('view-home');
            document.getElementById('u-name').innerText = `Hola, ${userData.username.split(' ')[0]}`;
            if(userData.role === 'admin') document.getElementById('admin-btn').classList.remove('hidden');
            loadRoutines(); loadGraph(); loadPhotos(); loadAdminData();
            
            // Estancamiento (14 d√≠as)
            const snap = await db.collection('users').doc(currentUser.uid).collection('history').orderBy('date','desc').limit(1).get();
            if(!snap.empty) {
                const diff = (new Date() - snap.docs[0].data().date.toDate())/(1000*3600*24);
                if(diff > 14) document.getElementById('stagnation-alert').classList.remove('hidden');
            }
        }

        function nav(vid) {
            document.querySelectorAll('.view').forEach(v=>v.classList.add('hidden'));
            document.getElementById(vid).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            if(vid.includes('home')) document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            if(vid.includes('progress')) document.querySelector('.nav-item:nth-child(2)').classList.add('active');
            if(vid.includes('config')) document.querySelector('.nav-item:nth-child(3)').classList.add('active');
        }

        // 8. RUTINAS
        async function loadRoutines() {
            const l = document.getElementById('routines-list'); l.innerHTML='';
            const s = await db.collection('users').doc(currentUser.uid).collection('routines').orderBy('createdAt','desc').get();
            s.forEach(d => {
                const r = d.data();
                const icons = r.exercises.slice(0,5).map(e=>`<img src="${e.image}" style="width:30px; margin-right:5px; border-radius:4px; background:white;">`).join('');
                const div = document.createElement('div'); div.className='card';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between;"><h3>${r.name}</h3><button onclick="delRout('${d.id}')" style="background:none; border:none; color:#666;">üóëÔ∏è</button></div>
                    <div style="margin:10px 0;">${icons}</div>
                    <button onclick="startWo('${d.id}')" class="btn btn-primary">ENTRENAR</button>`;
                l.appendChild(div);
            });
        }

        function openRoutineModal() { selectedExs=[]; document.getElementById('new-rout-name').value=''; renderExSelector(); document.getElementById('modal-create').classList.remove('hidden'); }
        function renderExSelector() {
            const f = document.getElementById('search-ex').value.toLowerCase();
            const c = document.getElementById('ex-list'); c.innerHTML='';
            exercisesDB.filter(e=>e.name.toLowerCase().includes(f)).forEach(e => {
                const d = document.createElement('div');
                d.style.cssText = `display:flex; align-items:center; gap:10px; padding:8px; border-bottom:1px solid #333; ${selectedExs.includes(e.id)?'background:rgba(255,68,68,0.2)':''}`;
                d.innerHTML = `<img src="${e.image}" style="width:40px; background:white; border-radius:4px;"><div><b>${e.name}</b><br><small style="color:#888">${e.muscle}</small></div>`;
                d.onclick = ()=>{ if(selectedExs.includes(e.id)) selectedExs=selectedExs.filter(x=>x!==e.id); else selectedExs.push(e.id); renderExSelector(); };
                c.appendChild(d);
            });
        }
        async function saveRoutine() {
            const name = document.getElementById('new-rout-name').value;
            if(!name || !selectedExs.length) return showToast("Faltan datos");
            const exs = selectedExs.map(id=>exercisesDB.find(e=>e.id===id));
            await db.collection('users').doc(currentUser.uid).collection('routines').add({name, exercises:exs, createdAt:firebase.firestore.FieldValue.serverTimestamp()});
            document.getElementById('modal-create').classList.add('hidden'); loadRoutines();
        }
        async function delRout(id) { if(confirm("¬øBorrar?")) await db.collection('users').doc(currentUser.uid).collection('routines').doc(id).delete(); loadRoutines(); }

        // 9. WORKOUT (CORE)
        async function startWo(id) {
            const doc = await db.collection('users').doc(currentUser.uid).collection('routines').doc(id).get();
            const r = doc.data(); activeRoutine = {id, ...r};
            
            if('wakeLock' in navigator) try{ wakeLock=await navigator.wakeLock.request('screen'); }catch(e){}
            document.getElementById('workout-ui').classList.add('active');
            document.getElementById('wo-title').innerText = r.name;
            const c = document.getElementById('wo-container'); c.innerHTML='';

            // Historial para pesos
            const hSnap = await db.collection('users').doc(currentUser.uid).collection('history').where('routineId','==',id).orderBy('date','desc').limit(1).get();
            const last = !hSnap.empty ? hSnap.docs[0].data() : null;

            // 5 Series: 1x20, 4x16
            const defReps = [20,16,16,16,16];

            r.exercises.forEach((ex, idx) => {
                let rows = '';
                for(let i=0; i<5; i++) {
                    const prev = last?.exercises[idx]?.sets[i]?.w || '-';
                    rows += `
                    <div class="set-row">
                        <div style="text-align:center; color:#888;">${i+1}</div>
                        <input type="number" class="input reps" value="${defReps[i]}" style="margin:0; text-align:center; height:35px;">
                        <div style="position:relative;">
                            <span class="prev-weight">${prev}kg</span>
                            <input type="number" class="input weight" placeholder="kg" style="margin:0; text-align:center; height:35px;">
                        </div>
                        <div style="font-size:0.7rem; color:#666; text-align:center;">RPE</div>
                        <div class="check-btn" onclick="checkSet(this, ${ex.id})">‚úì</div>
                    </div>`;
                }
                const card = document.createElement('div'); card.className='card';
                card.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <img src="${ex.image}" class="ex-img">
                            <h4>${ex.name}</h4>
                        </div>
                        <button onclick="openNote(${ex.id})" class="note-btn">üìù</button>
                    </div>
                    ${rows}`;
                c.appendChild(card);
            });

            woStartTime = new Date();
            if(woTimerInt) clearInterval(woTimerInt);
            woTimerInt = setInterval(()=>{
                const d = Math.floor((new Date()-woStartTime)/1000);
                document.getElementById('wo-timer').innerText = `${Math.floor(d/60).toString().padStart(2,'0')}:${(d%60).toString().padStart(2,'0')}`;
            },1000);
        }

        function checkSet(btn, exId) {
            if(btn.classList.contains('checked')) return;
            btn.classList.add('checked'); btn.parentElement.classList.add('done');
            
            // 1RM Alert
            const w = parseFloat(btn.parentElement.querySelector('.weight').value)||0;
            const r = parseFloat(btn.parentElement.querySelector('.reps').value)||0;
            if(w>0) {
                const onerm = w*(1+r/30);
                if(w > 100) showToast(`üèÜ ¬°R√©cord! 1RM: ${Math.round(onerm)}kg`); 
            }
            startRest();
        }

        function startRest() {
            const t = document.getElementById('float-timer'); t.classList.remove('hidden');
            let sec = userData.settings?.rest || 60; t.innerText = sec;
            if(restTimerInt) clearInterval(restTimerInt);
            restTimerInt = setInterval(()=>{
                sec--; t.innerText=sec;
                if(sec<=0) { 
                    clearInterval(restTimerInt); t.classList.add('hidden'); 
                    document.getElementById('beep').play().catch(e=>{}); navigator.vibrate(500); 
                }
            },1000);
        }
        function stopRest() { clearInterval(restTimerInt); document.getElementById('float-timer').classList.add('hidden'); }

        // Notas
        function openNote(id) { currentNoteExId = id; document.getElementById('modal-note').classList.remove('hidden'); }
        async function saveNote() {
            const txt = document.getElementById('note-text').value;
            // Aqu√≠ guardar√≠amos en local temp o DB
            showToast("Nota guardada");
            document.getElementById('modal-note').classList.add('hidden');
        }

        function finishPrompt() { document.getElementById('modal-rpe').classList.remove('hidden'); }
        async function saveWorkoutLog(rpe) {
            document.getElementById('modal-rpe').classList.add('hidden');
            // Save logic simplified for single file
            await db.collection('users').doc(currentUser.uid).collection('history').add({
                date: firebase.firestore.FieldValue.serverTimestamp(),
                routineId: activeRoutine.id, routineName: activeRoutine.name,
                duration: Math.floor((new Date()-woStartTime)/1000), rpe,
                exercises: [] 
            });
            if(wakeLock) wakeLock.release();
            exitWorkout(); showToast("‚úÖ Guardado con √©xito");
        }
        function exitWorkout() { document.getElementById('workout-ui').classList.remove('active'); stopRest(); }

        // 10. PROGRESS
        async function loadGraph() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            const s = await db.collection('users').doc(currentUser.uid).collection('weights').orderBy('date','asc').limit(10).get();
            const d = s.docs.map(x => ({x: x.data().date.toDate().toLocaleDateString(), y: x.data().val}));
            if(weightChart) weightChart.destroy();
            weightChart = new Chart(ctx, { type:'line', data:{labels:d.map(i=>i.x), datasets:[{label:'Peso', data:d.map(i=>i.y), borderColor:'#ff4444'}]}, options:{scales:{y:{beginAtZero:false}}} });
        }
        async function saveWeight() {
            const val = parseFloat(document.getElementById('new-weight').value);
            if(!val) return;
            await db.collection('users').doc(currentUser.uid).collection('weights').add({val, date:firebase.firestore.FieldValue.serverTimestamp()});
            loadGraph(); showToast("Peso registrado");
        }

        async function uploadPhoto(inp) {
            const f = inp.files[0];
            if(!f) return;
            
            // Resize Canvas
            const img = new Image();
            img.src = URL.createObjectURL(f);
            img.onload = async () => {
                const cvs = document.createElement('canvas'); const ctx = cvs.getContext('2d');
                const sc = 600/img.width; cvs.width=600; cvs.height=img.height*sc;
                ctx.drawImage(img,0,0,cvs.width,cvs.height);
                const b64 = cvs.toDataURL('image/jpeg', 0.6);
                
                await db.collection('users').doc(currentUser.uid).collection('photos').add({img:b64, date:firebase.firestore.FieldValue.serverTimestamp()});
                showToast("Foto subida"); loadPhotos();
            }
        }
        async function loadPhotos() {
            const g = document.getElementById('gallery'); g.innerHTML='';
            const s = await db.collection('users').doc(currentUser.uid).collection('photos').orderBy('date','desc').get();
            const p = s.docs.map(d=>d.data());
            if(p.length) {
                document.getElementById('comp-before').innerHTML = `<img src="${p[p.length-1].img}" style="width:100%; height:100%; object-fit:cover;">`;
                document.getElementById('comp-now').innerHTML = `<img src="${p[0].img}" style="width:100%; height:100%; object-fit:cover;">`;
            }
            p.forEach(x => {
                const d = document.createElement('div'); d.className='photo-item';
                d.innerHTML = `<img src="${x.img}"><div class="photo-date">${x.date?x.date.toDate().toLocaleDateString():''}</div>`;
                g.appendChild(d);
            });
        }

        // 11. ADMIN
        async function loadAdminData() {
            if(userData.role !== 'admin') return;
            const pend = document.getElementById('adm-pending'); const usrs = document.getElementById('adm-users');
            pend.innerHTML='...'; usrs.innerHTML='';
            const s = await db.collection('users').orderBy('createdAt','desc').get();
            let pH=''; let uH='';
            s.forEach(d => {
                const u = d.data();
                const item = `
                <div class="user-row">
                    <div><b>${u.username}</b><br><small style="color:#888">${u.email}</small></div>
                    <div>
                        ${!u.approved ? `<button onclick="approve('${d.id}')" class="btn-success" style="padding:4px 8px; width:auto; font-size:0.8rem;">OK</button>` : ''}
                        <button onclick="assignRout('${d.id}')" style="background:#333; border:none; padding:5px; margin-right:5px;">üìã</button>
                        <button onclick="delUser('${d.id}')" style="background:none; border:none; color:#666;">‚ùå</button>
                    </div>
                </div>`;
                if(!u.approved && u.role!=='admin') pH+=item;
                uH+=item;
            });
            pend.innerHTML = pH||'<p class="text-muted">Nada pendiente</p>'; usrs.innerHTML = uH;
        }
        async function approve(id) { await db.collection('users').doc(id).update({approved:true}); loadAdminData(); }
        async function delUser(id) { if(confirm("Borrar?")) await db.collection('users').doc(id).delete(); loadAdminData(); }
        async function assignRout(uid) {
            if(confirm("¬øAsignar rutina b√°sica?")) {
                const exs = exercisesDB.slice(0,5); 
                await db.collection('users').doc(uid).collection('routines').add({name:"Rutina Coach", exercises:exs, createdAt:new Date()});
                showToast("Rutina enviada");
            }
        }

        async function saveConfig() {
            const v = parseInt(document.getElementById('cfg-rest').value);
            await db.collection('users').doc(currentUser.uid).update({'settings.rest':v});
            showToast("Ajustes guardados");
        }
    </script>
</body>
</html>

